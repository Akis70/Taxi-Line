<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Secure Access</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" render="explicit" async defer></script>
    <style>
        :root { --yellow: #FFD700; --dark: #333; --light: #FFFFE0; --gold: #8B8000; --red: #d9534f; }
        body { background-color: var(--light); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-align: center; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 450px; margin: 20px auto; }
        .hidden { display: none !important; }
        .btn { width: 90%; padding: 14px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-yellow { background: var(--yellow); color: black; }
        .btn-dark { background: var(--dark); color: white; }
        input, select { width: 85%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; }
        .error-box { color: var(--red); font-weight: bold; margin: 10px; font-size: 14px; border: 1px solid var(--red); padding: 10px; border-radius: 5px; background: #fff1f1; }
        
        /* Loading Spinner */
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--gold); animation: spin 1s linear infinite; display: inline-block; margin: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen" class="container">
        <h1>Taxi-Line</h1>
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Password">
            <div id="login-err" class="error-box hidden"></div>
            <button class="btn btn-yellow" id="login-btn" onclick="attemptLogin()">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
            <div id="login-loader" class="hidden"><div class="spinner"></div><p>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚...</p></div>
            <p>ÎÎ­Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚; <a href="#" onclick="showView('register-screen')">Î•Î³Î³ÏÎ±Ï†Î®</a></p>
        </div>
        <div id="security-box" class="hidden"><div id="turnstile-container"></div></div>
    </div>

    <div id="register-screen" class="hidden container">
        <h2>Î•Î³Î³ÏÎ±Ï†Î®</h2>
        <input type="text" id="reg-name" placeholder="ÎŒÎ½Î¿Î¼Î±">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-pass" placeholder="Password (8+ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚)">
        <button class="btn btn-dark" id="reg-btn" onclick="processRegistration()">Î•Î³Î³ÏÎ±Ï†Î® & Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Email</button>
        <div id="reg-loader" class="hidden"><div class="spinner"></div><p>Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® email ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚...</p></div>
        <button class="btn" onclick="location.reload()">Î Î¯ÏƒÏ‰</button>
    </div>

    <div id="verify-screen" class="hidden container">
        <div style="font-size: 50px;">ğŸ“§</div>
        <h2>Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ Email ÏƒÎ±Ï‚</h2>
        <p>Î£Î±Ï‚ ÏƒÏ„ÎµÎ¯Î»Î±Î¼Îµ Î­Î½Î±Î½ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿. Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï„Î¿Î½ Ï€Î±Ï„Î®ÏƒÎµÏ„Îµ Î³Î¹Î± Î½Î± Î¼Ï€ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.</p>
        <button class="btn btn-yellow" onclick="location.reload()">Î•Ï€Î­ÏƒÏ„ÏÎµÏˆÎµ ÏƒÏ„Î·Î½ Î•Î¯ÏƒÎ¿Î´Î¿</button>
    </div>

    <div id="dashboard-hub" class="hidden container">
        <h2 style="color:green">ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ!</h2>
        <p>ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ ÏƒÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Ï€Î»Î­Î¿Î½ ÎµÎ½ÎµÏÎ³ÏŒÏ‚.</p>
        <button class="btn btn-yellow">Î†Î½Î¿Î¹Î³Î¼Î± Î§Î¬ÏÏ„Î·</button>
        <button class="btn btn-dark" onclick="location.reload()">Logout</button>
    </div>

    <script>
    const API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9..."; // Paste your full token here
    const GROUP_ID = "180133767592019782"; 
    const OWNER_PASS = "Aggelos2026!";

    function showView(id) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    async function processRegistration() {
    const email = document.getElementById('reg-email').value;
    const name = document.getElementById('reg-name').value;
    const regBtn = document.getElementById('reg-btn');
    const loader = document.getElementById('reg-loader');

    if(!email.includes('@')) return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï Î²Î¬Î»Ï„Îµ ÏƒÏ‰ÏƒÏ„ÏŒ email");

    // Show Loading Spinner
    regBtn.classList.add('hidden');
    loader.classList.remove('hidden');

    // THE FIX: Using a CORS bridge to ensure MailerLite receives the data
    const proxyUrl = "https://cors-anywhere.herokuapp.com/"; 
    const targetUrl = "https://connect.mailerlite.com/api/subscribers";

    try {
        const response = await fetch(proxyUrl + targetUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_TOKEN}`,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                email: email,
                fields: { name: name },
                groups: [GROUP_ID]
            })
        });

        if (response.ok) {
            showView('verify-screen');
        } else {
            const errData = await response.json();
            console.error("MailerLite Error:", errData);
            alert("Î£Ï†Î¬Î»Î¼Î± MailerLite: " + (errData.message || "Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬"));
            location.reload();
        }
    } catch(e) {
        // Fallback: If proxy is busy, try direct (might still block in some browsers)
        console.warn("Proxy error, trying direct...");
        try {
            await fetch(targetUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, groups: [GROUP_ID] })
            });
            showView('verify-screen');
        } catch(directErr) {
            alert("Î— ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Ï„Î¿ MailerLite Î±Ï€Î­Ï„Ï…Ï‡Îµ. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ API Token ÏƒÎ±Ï‚.");
            location.reload();
        }
    }
}

    async function attemptLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const errBox = document.getElementById('login-err');

        if(pass === OWNER_PASS) { showView('dashboard-hub'); return; }

        // Show Spinner
        document.getElementById('login-btn').classList.add('hidden');
        document.getElementById('login-loader').classList.remove('hidden');
        errBox.classList.add('hidden');

        try {
            const response = await fetch(`https://connect.mailerlite.com/api/subscribers/${email}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            });
            const result = await response.json();

            if (result.data && result.data.status === 'active') {
                // Verified in MailerLite!
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('security-box').classList.remove('hidden');
                turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAACgb7i5zYwkXn5g5',
                    callback: () => showView('dashboard-hub')
                });
            } else {
                throw new Error("unconfirmed");
            }
        } catch (error) {
            document.getElementById('login-btn').classList.remove('hidden');
            document.getElementById('login-loader').classList.add('hidden');
            errBox.innerText = "âŒ Î ÏÏŒÏƒÎ²Î±ÏƒÎ· Î‘ÏÎ½Î·Î¸ÎµÎ¯ÏƒÎ±: Î ÏÎ­Ï€ÎµÎ¹ Ï€ÏÏÏ„Î± Î½Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÎµÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚!";
            errBox.classList.remove('hidden');
        }
    }
    </script>
</body>
</html>


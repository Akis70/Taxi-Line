<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Secure Access</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" render="explicit" async defer></script>
    <style>
        :root { --yellow: #FFD700; --dark: #333; --light: #FFFFE0; --gold: #8B8000; --red: #ff4d4d; }
        body { background-color: var(--light); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-align: center; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 480px; margin: 20px auto; }
        .hidden { display: none !important; }
        .btn { width: 90%; padding: 14px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-yellow { background: var(--yellow); color: black; }
        .btn-dark { background: var(--dark); color: white; }
        input, select { width: 85%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; }
        .error-msg { color: var(--red); font-weight: bold; font-size: 14px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="login-screen" class="container">
        <div style="font-size: 50px;">ðŸš•</div>
        <h1>Taxi-Line</h1>
        <p><i>Head-Admin: Aggelos Gkioulekas</i></p>
        
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email Address">
            <input type="password" id="login-pass" placeholder="Password">
            <div id="login-error" class="error-msg hidden">Account not verified or not found!</div>
            <button class="btn btn-yellow" onclick="attemptLogin()">Login</button>
            <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
        </div>

        <div id="security-box" class="hidden">
            <div id="turnstile-container"></div>
            <p>Finalizing Security...</p>
        </div>
    </div>

    <div id="register-screen" class="hidden container">
        <h2>New Registration</h2>
        <input type="text" id="reg-name" placeholder="Full Name">
        <input type="email" id="reg-email" placeholder="Email Address">
        <input type="password" id="reg-pass" placeholder="Create Password (8+ chars)">
        <select id="reg-role">
            <option value="passenger">Passenger</option>
            <option value="driver">Driver</option>
        </select>
        <button class="btn btn-dark" onclick="processRegistration()">Register & Send Email</button>
        <button class="btn" onclick="location.reload()">Back</button>
    </div>

    <div id="verify-screen" class="hidden container">
        <div style="font-size: 50px;">ðŸ“§</div>
        <h2>Verification Sent!</h2>
        <p>We sent a link to <b id="display-email"></b>.</p>
        <p>You <b>cannot login</b> until you verify your email via MailerLite.</p>
        <hr>
        <p style="font-size: 12px; color: #666;">(Testing Mode: Click below to simulate the email link being clicked)</p>
        <button class="btn btn-yellow" onclick="simulateVerification()">Simulate: Verify My Email</button>
    </div>

    <div id="dashboard-hub" class="hidden container">
        <h2 style="color:green">âœ“ Access Granted</h2>
        <p>Select your dashboard:</p>
        <button class="btn btn-yellow">Passenger Dashboard</button>
        <button class="btn btn-yellow">Driver Dashboard</button>
        <button class="btn btn-dark" onclick="location.reload()">Logout</button>
    </div>

    <script>
        // Use LocalStorage to "remember" if the user is verified during your testing
        let registeredEmail = localStorage.getItem('taxi_email') || "";
        let isVerified = localStorage.getItem('taxi_verified') === "true";

        function showRegister() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        }

        async function processRegistration() {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            if(!email.includes('@') || pass.length < 8) {
                alert("Please enter a valid email and 8+ char password.");
                return;
            }

            // Save to local storage (Simulating a database)
            localStorage.setItem('taxi_email', email);
            localStorage.setItem('taxi_pass', pass);
            localStorage.setItem('taxi_verified', "false");

            // API Call to MailerLite
            try {
                await fetch('https://connect.mailerlite.com/api/subscribers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...' // Your token
                    },
                    body: JSON.stringify({ email: email })
                });
            } catch(e) { console.log("MailerLite Sent"); }

            document.getElementById('display-email').innerText = email;
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('verify-screen').classList.remove('hidden');
        }

        function simulateVerification() {
            localStorage.setItem('taxi_verified', "true");
            alert("Email verified successfully! You may now login.");
            location.reload();
        }

        function attemptLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            const storedEmail = localStorage.getItem('taxi_email');
            const storedPass = localStorage.getItem('taxi_pass');
            const verified = localStorage.getItem('taxi_verified');

            // THE LOCK: Only allow if Email/Pass matches AND verified is true
            if (email === storedEmail && pass === storedPass && verified === "true") {
                startSecurityCheck();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                setTimeout(() => { document.getElementById('login-error').classList.add('hidden'); }, 3000);
            }
        }

        function startSecurityCheck() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('security-box').classList.remove('hidden');
            turnstile.render('#turnstile-container', {
                sitekey: '0x4AAAAAACgb7i5zYwkXn5g5',
                callback: () => {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('dashboard-hub').classList.remove('hidden');
                }
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Pro Production</title>
    
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" render="explicit" async defer></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --yellow: #FFD700; --dark: #333; --light: #FFFFE0; --gold: #8B8000; --red: #d9534f; --green: #28a745; }
        body { background-color: var(--light); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-align: center; color: var(--dark); }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 450px; margin: 20px auto; }
        .hidden { display: none !important; }
        .btn { width: 90%; padding: 14px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-yellow { background: var(--yellow); color: black; }
        .btn-dark { background: var(--dark); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-green { background: var(--green); color: white; }
        input, select { width: 85%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; }
        #map-area { height: 350px; width: 100%; border-radius: 10px; border: 2px solid var(--gold); margin-top: 15px; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--gold); animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen" class="container">
        <h1>Taxi-Line</h1>
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Password">
            <div id="login-err" class="hidden" style="color:var(--red); margin:10px;"></div>
            <button class="btn btn-yellow" id="login-btn" onclick="attemptLogin()">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
            <div id="login-loader" class="hidden"><div class="spinner"></div></div>
            <p>ÎÎ­Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚; <a href="#" onclick="showView('register-screen')">Î•Î³Î³ÏÎ±Ï†Î®</a></p>
        </div>
        <div id="security-box" class="hidden"><div id="turnstile-container"></div></div>
    </div>

    <div id="register-screen" class="hidden container">
        <h2>Î•Î³Î³ÏÎ±Ï†Î®</h2>
        <input type="text" id="reg-name" placeholder="ÎŒÎ½Î¿Î¼Î±">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-pass" placeholder="Password (8+ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚)">
        <select id="reg-role">
            <option value="passenger">Î•Ï€Î¹Î²Î¬Ï„Î·Ï‚</option>
            <option value="driver">ÎŸÎ´Î·Î³ÏŒÏ‚ Î¤Î±Î¾Î¯</option>
        </select>
        <button class="btn btn-dark" id="reg-btn" onclick="processRegistration()">Î•Î³Î³ÏÎ±Ï†Î®</button>
        <div id="reg-loader" class="hidden"><div class="spinner"></div></div>
        <button class="btn" onclick="location.reload()">Î Î¯ÏƒÏ‰</button>
    </div>

    <div id="verify-screen" class="hidden container">
        <h2>ğŸ“§ Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ Email</h2>
        <p>Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚ Î±Ï€ÏŒ Ï„Î¿ link Ï€Î¿Ï… ÏƒÎ±Ï‚ ÏƒÏ„ÎµÎ¯Î»Î±Î¼Îµ.</p>
        <button class="btn btn-yellow" onclick="location.reload()">Î Î®Î³Î± ÏƒÏ„Î¿ Email</button>
    </div>

    <div id="passenger-dashboard" class="hidden container">
        <h3>ğŸ“ Î§Î¬ÏÏ„Î·Ï‚ Î¤Î±Î¾Î¯</h3>
        <div id="map-area"></div>
        <button class="btn btn-yellow" onclick="requestRide()">ğŸš• ÎšÎ»Î®ÏƒÎ· Î¤Î±Î¾Î¯</button>
        <a href="tel:+306999222446" class="btn btn-red" style="text-decoration:none; display:block; width:84%; margin:10px auto;">ğŸ“ Î¤Î·Î»ÎµÏ†Ï‰Î½Î¹ÎºÎ® ÎšÎ»Î®ÏƒÎ·</a>
        <button class="btn btn-dark" onclick="location.reload()">Logout</button>
    </div>

    <div id="driver-dashboard" class="hidden container">
        <h3>ğŸ‘¨â€âœˆï¸ Î Î¯Î½Î±ÎºÎ±Ï‚ ÎŸÎ´Î·Î³Î¿Ï</h3>
        <div style="background:#f9f9f9; padding:20px; border-radius:10px; border:1px solid #ddd;">
            <p>Status: <b id="driver-status-text" style="color:var(--red)">OFFLINE</b></p>
            <button class="btn btn-green" onclick="toggleDriverStatus()">Go Online</button>
        </div>
        <a href="tel:+306999222446" class="btn btn-dark" style="text-decoration:none; display:block; width:84%; margin:10px auto;">ğŸ“ Call Admin</a>
        <button class="btn btn-dark" onclick="location.reload()">Logout</button>
    </div>

    <script>
    const API_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI0IiwianRpIjoiMzE0N2MxZGQ1ZWRhOGJmNmI0ZmU3MDdkMjYyNWVkODMxYzIxNjc5OWYxOTQ0OTMwNTFmOTU3YmJkNmUwYWU2MDAwM2Q3MTEyMTgzYTAzMzgiLCJpYXQiOjE3NzE3OTg1NTguNDg0MTc0LCJuYmYiOjE3NzE3OTg1NTguNDg0MTc3LCJleHAiOjQ5Mjc0NzIxNTguNDc1NTYzLCJzdWIiOiIyMTUxNDUwIiwic2NvcGVzIjpbXX0.wSW95HXK43Rn4cQBNHMcOc0jCr6VTw8MDQxegUso8OSsaabMNbnLNE4fTSaDeuvK4sS7cet_cp6dY4-DC3qUt6OzJTzVMlwgQ4r12qXKDFZOr1XATkPNWBLMstv7_Kj1f-swF736jUxSOZBlfermR5OcnkLew6GuEcGyQFJ_h3FeBA5nrZjN1zVn5Vdw8IFex0MfSHGmBDpVkXrczz9xYV9OLOxcc9g5H9FfR7P9fpFtmlVvjL7X4jQpZxaztgX8B-hEfEHrAmVqq2E3GPEydOT-tFf3okiHqSzUoOABA_BhlEIpOghOLfaJiUQsIQdnxtipYm20Fqm--DQpJt7HgKm92xul1hCqLB_g_462ev3jXQTPmukYnZ4v2iQZQ_TM7kHLL6qNXkZ0-o6K40Yg05iYVnz1dl8ae8t4l5p_uin9_HWmzRraGMm0bNzL98gYGfbwQa9-RK3RJjzGH7dY6715quchq9u19Z7-ezP1CN1o_jNDkC-2dnr1cA-tG7ddzBASH-S_lhNt1D4-gprOcRbh5sQ07f5hN0Uk8-ngamrGNNDytACNHSgtjJjJ-uKNv58QbY-hFmy_47b78O4nlCBOUXJcKbIs6EVaZz9WT-7mBl_ZqQRv9yfnR9HiZHZ-raBT26c1eU3Kiy60ZT8-8qQQId1VIotYy5JmpYGGoxw";
    const GROUP_ID = "180133767592019782"; 
    const OWNER_PASS = "Aggelos2026!";

    function showView(id) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    async function processRegistration() {
        const email = document.getElementById('reg-email').value;
        const role = document.getElementById('reg-role').value;
        localStorage.setItem('user_role', role);

        document.getElementById('reg-btn').classList.add('hidden');
        document.getElementById('reg-loader').classList.remove('hidden');

        try {
            await fetch('https://connect.mailerlite.com/api/subscribers', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, groups: [GROUP_ID], status: "unconfirmed" })
            });
            showView('verify-screen');
        } catch(e) { location.reload(); }
    }

    async function attemptLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;

        if(pass === OWNER_PASS) { showView('passenger-dashboard'); initMap(); return; }

        document.getElementById('login-btn').classList.add('hidden');
        document.getElementById('login-loader').classList.remove('hidden');

        try {
            const response = await fetch(`https://connect.mailerlite.com/api/subscribers/${email}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            });
            const result = await response.json();

            if (result.data && result.data.status === 'active') {
                const role = localStorage.getItem('user_role') || 'passenger';
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('security-box').classList.remove('hidden');
                
                turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAACgb7i5zYwkXn5g5',
                    callback: () => {
                        if(role === 'driver') showView('driver-dashboard');
                        else { showView('passenger-dashboard'); initMap(); }
                    }
                });
            } else { throw new Error(); }
        } catch (e) {
            document.getElementById('login-btn').classList.remove('hidden');
            document.getElementById('login-loader').classList.add('hidden');
            document.getElementById('login-err').innerText = "âŒ Î•Ï€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚!";
            document.getElementById('login-err').classList.remove('hidden');
        }
    }

    function initMap() {
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const map = L.map('map-area').setView([lat, lon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lon]).addTo(map).bindPopup("Î•ÏƒÎµÎ¯Ï‚").openPopup();
            L.circle([lat, lon], { radius: 5000, color: 'gold', fillOpacity: 0.1 }).addTo(map);
            const tIcon = L.divIcon({ html: 'ğŸš•', className: 't', iconSize:[30,30] });
            L.marker([lat + 0.003, lon + 0.003], {icon: tIcon}).addTo(map).bindPopup("Taxi #10 - 4 min");
        });
    }

    function requestRide() {
        alert("Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¿Î´Î·Î³Î¿Ï... Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ· Î¼Î±Ï‚.");
    }

    function toggleDriverStatus() {
        const t = document.getElementById('driver-status-text');
        t.innerText = t.innerText === "OFFLINE" ? "ONLINE" : "OFFLINE";
        t.style.color = t.innerText === "ONLINE" ? "var(--green)" : "var(--red)";
    }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #f1c40f; --secondary: #2c3e50; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f4f4; text-align: center; }
        .top-bar { background: var(--secondary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #map { height: 400px; width: 100%; border-radius: 8px; border: 2px solid var(--primary); margin-top: 15px; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; transition: 0.3s; font-size: 16px; }
        .hidden { display: none; }
        
        /* Modal Style */
        #ride-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; }
        .modal-content input { width: 60px; padding: 10px; font-size: 18px; text-align: center; margin: 10px; border: 1px solid #ccc; border-radius: 5px; }
        
        /* Notifications */
        .call-alert { background: #fff3e0; border: 4px solid #ff9800; padding: 15px; margin-top: 15px; border-radius: 10px; animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <strong>ğŸš• Taxi-Line</strong>
        <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
    </div>

    <div id="loading-screen" style="padding-top:100px;">
        <h2>ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</h2>
    </div>

    <div id="main-content" class="hidden">
        <div class="dashboard-container">
            <h2 id="welcome-msg">ÎšÎ±Î»ÏÏ‚ Î¿ÏÎ¯ÏƒÎ±Ï„Îµ</h2>
            
            <div id="driver-section" class="hidden">
                <div id="driver-status-box" style="background:#e8f5e9; padding:20px; border-radius:10px;">
                    <h3>ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï</h3>
                    <div id="online-controls">
                        <button class="btn" style="background:var(--success); color:white;" onclick="goOnline()">GO ONLINE</button>
                    </div>
                </div>
            </div>

            <div id="passenger-section" class="hidden">
                <div id="search-view">
                    <h3>ğŸ“ Î¤Î±Î¾Î¯ ÏƒÏ„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î®</h3>
                    <div id="map"></div>
                    <a href="tel:6999222446" class="btn" style="background:#3498db; color:white; display:block; margin-top:15px; text-decoration:none;">ğŸ“ ÎšÎ›Î—Î£Î— Î¡Î‘Î”Î™ÎŸÎ¤Î‘ÎÎ™</a>
                </div>
                <div id="status-view" class="hidden"></div>
            </div>
        </div>
    </div>

    <div id="ride-modal">
        <div class="modal-content">
            <h3>ğŸš• Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÎšÎ»Î®ÏƒÎ·Ï‚</h3>
            <p>Î ÏŒÏƒÎ± Î¬Ï„Î¿Î¼Î± Î¸Î± ÎµÏ€Î¹Î²Î¹Î²Î±ÏƒÏ„Î¿ÏÎ½;</p>
            <input type="number" id="pass-count" value="1" min="1" max="8">
            <div style="margin: 15px 0;">
                <label style="font-size: 18px;"><input type="checkbox" id="has-luggage" style="width:20px; height:20px;"> ÎˆÏ‡Ï‰ Î±Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚</label>
            </div>
            <button class="btn" style="background:var(--success); color:white;" onclick="confirmRideRequest()">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— ÎšÎ›Î—Î£Î—Î£</button>
            <button class="btn" style="background:#95a5a6; color:white;" onclick="closeModal()">Î‘ÎšÎ¥Î¡Î©Î£Î—</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let map, watchId, heartbeatInterval, userRole, userPhone, userTaxiNum, selectedDriverId;
        let taxiMarkers = {};
        const taxiIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [40, 40] });

        auth.onAuthStateChanged(user => {
            if (user) checkUser(user.uid);
            else window.location.href = "index.html";
        });

        function checkUser(uid) {
            database.ref('users/' + uid).once('value').then(snap => {
                const data = snap.val();
                if (!data) return window.location.href = "signup.html";
                
                userRole = data.role;
                userPhone = data.phone || "N/A";
                userTaxiNum = data.taxiNumber || "N/A";
                
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = "Î“ÎµÎ¹Î± ÏƒÎ±Ï‚, " + data.email;

                if (userRole === 'driver') {
                    document.getElementById('driver-section').classList.remove('hidden');
                    listenForRides();
                } else {
                    document.getElementById('passenger-section').classList.remove('hidden');
                    initMap();
                }
            });
        }

        // --- SHARED LOGIC ---
        function playSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.3);
        }

        // --- DRIVER LOGIC ---
        function goOnline() {
            playSound(); // ÎÎµÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹ Ï„Î¿Î½ Î®Ï‡Î¿ ÏƒÏ„Î¿Î½ browser
            if (navigator.geolocation) {
                const driverRef = database.ref('available_drivers/' + auth.currentUser.uid);
                driverRef.onDisconnect().remove();
                
                heartbeatInterval = setInterval(() => {
                    driverRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
                }, 30000);

                watchId = navigator.geolocation.watchPosition(pos => {
                    driverRef.update({
                        taxiNumber: userTaxiNum,
                        location: { lat: pos.coords.latitude, lon: pos.coords.longitude },
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                });

                document.getElementById('online-controls').innerHTML = `
                    <h2 style="color:var(--danger);">ğŸ”´ Î•Î™Î£Î¤Î• LIVE</h2>
                    <button class="btn" style="background:#f39c12; color:white;" onclick="location.reload()">GO OFFLINE</button>
                `;
            }
        }

        function listenForRides() {
            database.ref('ride_requests').on('value', snap => {
                const reqs = snap.val();
                if (!reqs) return;
                for (let id in reqs) {
                    if (reqs[id].targetDriverId === auth.currentUser.uid && reqs[id].status === "waiting") {
                        if (!document.getElementById('incoming-call')) {
                            playSound();
                            showDriverAlert(id, reqs[id]);
                        }
                    }
                }
            });
        }

        function showDriverAlert(id, data) {
            const box = document.getElementById('driver-status-box');
            const div = document.createElement('div');
            div.id = "incoming-call";
            div.className = "call-alert";
            div.innerHTML = `
                <h3>ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h3>
                <p>ğŸ‘¥ Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚: ${data.details.count} | ğŸ§³ Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚: ${data.details.hasLuggage}</p>
                <button class="btn" style="background:var(--success); color:white;" onclick="acceptRide('${id}', '${data.passengerPhone}')">Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>
            `;
            box.appendChild(div);
        }

        function acceptRide(id, phone) {
            database.ref('ride_requests/' + id).update({ status: "accepted" }).then(() => {
                if (watchId) navigator.geolocation.clearWatch(watchId);
                database.ref('available_drivers/' + auth.currentUser.uid).remove();
                document.getElementById('online-controls').innerHTML = `
                    <div style="background:var(--secondary); color:white; padding:20px; border-radius:10px;">
                        <h3>ğŸš• Î”Î™Î‘Î”Î¡ÎŸÎœÎ— Î£Î• Î•ÎÎ•Î›Î™ÎÎ—</h3>
                        <button class="btn" style="background:var(--primary); color:black;" onclick="window.location.href='tel:${phone}'">ğŸ“ ÎšÎ›Î—Î£Î— Î Î•Î›Î‘Î¤Î—</button>
                        <button class="btn" style="background:var(--danger); color:white;" onclick="location.reload()">ğŸ Î¤Î•Î›ÎŸÎ£ Î”Î™Î‘Î”Î¡ÎŸÎœÎ—Î£</button>
                    </div>
                `;
            });
        }

        // --- PASSENGER LOGIC ---
        function initMap() {
            navigator.geolocation.getCurrentPosition(pos => {
                map = L.map('map').setView([pos.coords.latitude, pos.coords.longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(map).bindPopup('Î•ÏƒÎµÎ¯Ï‚');
                loadTaxis();
            });
        }

        function loadTaxis() {
            database.ref('available_drivers').on('value', snap => {
                const drivers = snap.val();
                for (let id in taxiMarkers) { map.removeLayer(taxiMarkers[id]); delete taxiMarkers[id]; }
                if (!drivers) return;
                for (let id in drivers) {
                    const d = drivers[id];
                    taxiMarkers[id] = L.marker([d.location.lat, d.location.lon], { icon: taxiIcon }).addTo(map)
                        .bindPopup(`<b>Î¤Î±Î¾Î¯ No: ${d.taxiNumber}</b><br><button onclick="openRideModal('${id}')" style="background:var(--primary); border:none; padding:5px; cursor:pointer; font-weight:bold; margin-top:5px; border-radius:3px;">ğŸš• ÎšÎ›Î—Î£Î—</button>`);
                }
            });
        }

        function openRideModal(id) {
            selectedDriverId = id;
            document.getElementById('ride-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('ride-modal').style.display = 'none'; }

        function confirmRideRequest() {
            const count = document.getElementById('pass-count').value;
            const luggage = document.getElementById('has-luggage').checked ? "ÎÎ±Î¹" : "ÎŒÏ‡Î¹";
            const rideId = auth.currentUser.uid;

            database.ref('ride_requests/' + rideId).set({
                passengerId: rideId, passengerPhone: userPhone,
                targetDriverId: selectedDriverId,
                details: { count: count, hasLuggage: luggage },
                status: "waiting", timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                closeModal();
                alert("Î— ÎºÎ»Î®ÏƒÎ· ÎµÏƒÏ„Î¬Î»Î·! Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î±Ï€Î¿Î´Î¿Ï‡Î®...");
                
                // Listener Î³Î¹Î± Ï„Î·Î½ Î±Ï€Î¿Î´Î¿Ï‡Î®
                database.ref('ride_requests/' + rideId).on('value', snap => {
                    if (snap.val() && snap.val().status === "accepted") {
                        document.getElementById('search-view').classList.add('hidden');
                        const statusView = document.getElementById('status-view');
                        statusView.classList.remove('hidden');
                        statusView.innerHTML = `
                            <div style="background:#d4edda; border:2px solid var(--success); padding:30px; border-radius:15px; margin-top:20px;">
                                <h1 style="color:var(--success);">âœ… ÎŸ ÎŸÎ”Î—Î“ÎŸÎ£ Î•Î¡Î§Î•Î¤Î‘Î™!</h1>
                                <p>Î¤Î¿ Î¤Î±Î¾Î¯ Î±Ï€Î¿Î´Î­Ï‡Ï„Î·ÎºÎµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ· ÏƒÎ±Ï‚ ÎºÎ±Î¹ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Ï„Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î®.</p>
                                <button class="btn" style="background:var(--success); color:white;" onclick="location.reload()">ÎÎ•Î‘ Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î—</button>
                            </div>
                        `;
                    }
                });
            });
        }

        function logout() {
            if (userRole === 'driver') database.ref('available_drivers/' + auth.currentUser.uid).remove().then(() => auth.signOut());
            else auth.signOut();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --primary: #f1c40f; --secondary: #2c3e50; --success: #27ae60; 
            --danger: #e74c3c; --warning: #f39c12; --bg: #f4f4f4; --card-bg: #ffffff; --text: #333;
        }
        body.dark-mode { 
            --bg: #1a1a1a; --card-bg: #2d2d2d; --text: #f4f4f4; --secondary: #000;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); text-align: center; transition: 0.3s; }
        .top-bar { background: var(--secondary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dashboard-container { max-width: 800px; margin: 20px auto; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: var(--text); }
        
        #map, #driver-map { height: 400px; width: 100%; border-radius: 8px; border: 2px solid var(--primary); margin-top: 15px; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; transition: 0.3s; font-size: 16px; text-transform: uppercase; }
        .hidden { display: none; }
        
        /* Priority List Styling */
        #priority-list-container { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left; border-left: 5px solid var(--primary); }
        #driver-priority-list li { padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 15px; }
        
        #ride-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); color: var(--text); padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; }
        
        .call-alert { background: #fff3e0; border: 4px solid var(--warning); padding: 15px; margin-top: 15px; border-radius: 10px; color: #333; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--warning); border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="top-bar">
        <strong>ğŸš• Taxi-Line</strong>
        <div id="top-buttons" style="display:flex; align-items:center;">
            <button onclick="toggleDarkMode()" style="background:#444; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; margin-right:5px;">ğŸŒ™</button>
            <button id="lang-toggle" onclick="toggleLanguage()" style="background:#444; color:white; border:1px solid #777; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold; margin-right:10px;">EN</button>
            <button id="logout-btn" onclick="logout()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">Î•ÎÎŸÎ”ÎŸÎ£</button>
        </div>
    </div>

    <div id="loading-screen" style="padding-top:100px;">
        <h2 id="load-text">ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</h2>
    </div>

    <div id="main-content" class="hidden">
        <div class="dashboard-container">
            <h2 id="welcome-msg">ÎšÎ±Î»ÏÏ‚ Î¿ÏÎ¯ÏƒÎ±Ï„Îµ</h2>
            
            <div id="driver-section" class="hidden">
                <div id="driver-status-box" style="padding:20px; border-radius:10px; border: 1px solid var(--primary);">
                    <h3 id="driver-panel-title">ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï</h3>
                    
                    <div id="priority-list-container" class="hidden">
                        <strong>ğŸš– Î£ÎµÎ¹ÏÎ¬ Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚:</strong>
                        <ul id="driver-priority-list" style="list-style:none; padding:0; margin-top:10px;"></ul>
                    </div>

                    <div id="online-controls">
                        <button id="go-online-btn" class="btn" style="background:var(--success); color:white;" onclick="goOnline()">GO ONLINE</button>
                    </div>

                    <div id="driver-map-container" class="hidden">
                        <p>ğŸ“ Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Î•Ï€Î¹Î²Î¬Ï„Î·:</p>
                        <div id="driver-map"></div>
                    </div>
                </div>
            </div>

            <div id="passenger-section" class="hidden">
                <div id="search-view">
                    <h3 id="available-taxis-title">ğŸ“ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¤Î±Î¾Î¯</h3>
                    <div id="map"></div>
                    <a id="call-radio-btn" href="tel:6999222446" class="btn" style="background:#3498db; color:white; display:block; margin-top:15px; text-decoration:none;">ğŸ“ ÎšÎ›Î—Î£Î— Î¡Î‘Î”Î™ÎŸÎ¤Î‘ÎÎ™</a>
                </div>
                <div id="status-view" class="hidden"></div>
            </div>
        </div>
    </div>

    <div id="ride-modal">
        <div class="modal-content">
            <h3 id="modal-title">ğŸš• Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÎšÎ»Î®ÏƒÎ·Ï‚</h3>
            <p id="modal-pass-label">Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎµÏ€Î¹Î²Î±Ï„ÏÎ½:</p>
            <input type="number" id="pass-count" value="1" min="1" max="8" style="width:60px; padding:10px; font-size:18px; text-align:center;">
            <div style="margin: 20px 0;">
                <label style="font-size: 18px; cursor:pointer;"><input type="checkbox" id="has-luggage" style="width:20px; height:20px;"> <span id="modal-luggage-label">ÎˆÏ‡Ï‰ Î±Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚</span></label>
            </div>
            <button id="modal-send-btn" class="btn" style="background:var(--success); color:white;" onclick="confirmRideRequest()">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— ÎšÎ›Î—Î£Î—Î£</button>
            <button id="modal-cancel-btn" class="btn" style="background:#95a5a6; color:white;" onclick="closeModal()">Î‘ÎšÎ¥Î¡Î©Î£Î—</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let map, driverMap, watchId, heartbeatInterval, userRole, userPhone, userTaxiNum, selectedDriverId;
        let taxiMarkers = {};
        const taxiIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [40, 40] });
        const notificationAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        notificationAudio.loop = true;

        let currentLang = localStorage.getItem('appLang') || 'el';
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

        const translations = {
            el: {
                langBtn: "EN", loadText: "ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...", exitBtn: "Î•ÎÎŸÎ”ÎŸÎ£", welcome: "Î“ÎµÎ¹Î± ÏƒÎ±Ï‚, ",
                driverTitle: "ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï", goOnline: "GO ONLINE", goOffline: "GO OFFLINE", live: "ğŸ”´ Î•Î™Î£Î¤Î• LIVE",
                passTitle: "ğŸ“ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¤Î±Î¾Î¯", callRadio: "ğŸ“ ÎšÎ›Î—Î£Î— Î¡Î‘Î”Î™ÎŸÎ¤Î‘ÎÎ™",
                modalTitle: "ğŸš• Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÎšÎ»Î®ÏƒÎ·Ï‚", modalPass: "Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎµÏ€Î¹Î²Î±Ï„ÏÎ½:", modalLuggage: "ÎˆÏ‡Ï‰ Î±Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚", modalSend: "Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— ÎšÎ›Î—Î£Î—Î£", modalCancel: "Î‘ÎšÎ¥Î¡Î©Î£Î—",
                incoming: "ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!", accept: "Î‘Î ÎŸÎ”ÎŸÎ§Î—", tripActive: "ğŸš• Î”Î™Î‘Î”Î¡ÎŸÎœÎ— Î£Î• Î•ÎÎ•Î›Î™ÎÎ—", callPass: "ğŸ“ ÎšÎ›Î—Î£Î— Î•Î Î™Î’Î‘Î¤Î—", arrivedBtn: "ğŸ“¢ Î•Î¦Î¤Î‘Î£Î‘",
                waiting: "â³ ÎŸ ÎŸÎ”Î—Î“ÎŸÎ£ Î•Î¡Î§Î•Î¤Î‘Î™", taxiArrived: "ğŸš• Î¤ÎŸ Î¤Î‘ÎÎ™ Î•Î¦Î¤Î‘Î£Î•!", newSearch: "ÎÎ•Î‘ Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î—"
            },
            en: {
                langBtn: "GR", loadText: "ğŸ”„ Loading...", exitBtn: "LOGOUT", welcome: "Hello, ",
                driverTitle: "ğŸ‘¨â€âœˆï¸ Driver Panel", goOnline: "GO ONLINE", goOffline: "GO OFFLINE", live: "ğŸ”´ YOU ARE LIVE",
                passTitle: "ğŸ“ Available Taxis", callRadio: "ğŸ“ CALL RADIO TAXI",
                modalTitle: "ğŸš• Ride Details", modalPass: "Passengers:", modalLuggage: "Luggage", modalSend: "SEND REQUEST", modalCancel: "CANCEL",
                incoming: "ğŸ”” NEW RIDE!", accept: "ACCEPT", tripActive: "ğŸš• TRIP ACTIVE", callPass: "ğŸ“ CALL PASSENGER", arrivedBtn: "ğŸ“¢ ARRIVED",
                waiting: "â³ DRIVER IS COMING", taxiArrived: "ğŸš• TAXI ARRIVED!", newSearch: "NEW SEARCH"
            }
        };

        function toggleLanguage() {
            currentLang = (currentLang === 'el') ? 'en' : 'el';
            localStorage.setItem('appLang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            const t = translations[currentLang];
            document.getElementById('lang-toggle').innerText = t.langBtn;
            document.getElementById('load-text').innerText = t.loadText;
            document.getElementById('logout-btn').innerText = t.exitBtn;
            document.getElementById('driver-panel-title').innerText = t.driverTitle;
            document.getElementById('available-taxis-title').innerText = t.passTitle;
            document.getElementById('call-radio-btn').innerText = t.callRadio;
            document.getElementById('modal-title').innerText = t.modalTitle;
            document.getElementById('modal-pass-label').innerText = t.modalPass;
            document.getElementById('modal-luggage-label').innerText = t.modalLuggage;
            document.getElementById('modal-send-btn').innerText = t.modalSend;
            document.getElementById('modal-cancel-btn').innerText = t.modalCancel;
            if (auth.currentUser) document.getElementById('welcome-msg').innerText = t.welcome + auth.currentUser.email;
        }

        // --- AUTH & CHECK ---
        auth.onAuthStateChanged(user => {
            if (user) {
                const myAdminEmail = "akisss70@gmail.com";
                if (user.emailVerified || user.email === myAdminEmail) {
                    applyLanguage();
                    checkUser(user.uid);
                } else {
                    alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚!");
                    auth.signOut().then(() => window.location.href = "index.html");
                }
            } else {
                window.location.href = "index.html";
            }
        });

        function checkUser(uid) {
            database.ref('users/' + uid).once('value').then(snap => {
                const data = snap.val();
                if (!data) return window.location.href = "signup.html";
                
                userRole = data.role;
                userPhone = data.phone || "N/A";
                userTaxiNum = data.taxiNumber || "N/A";

                const topBtnArea = document.getElementById('top-buttons');
                if (data.email === "akisss70@gmail.com" && !document.getElementById('admin-btn')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.id = "admin-btn"; adminBtn.innerText = "ğŸ› ï¸";
                    adminBtn.style = "background:#f1c40f; color:#000; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold; margin-right:5px;";
                    adminBtn.onclick = () => window.location.href = 'admin.html';
                    topBtnArea.insertBefore(adminBtn, topBtnArea.firstChild);
                }

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

                if (userRole === 'driver') {
                    document.getElementById('driver-section').classList.remove('hidden');
                    updatePriorityList();
                    listenForRides();
                } else {
                    document.getElementById('passenger-section').classList.remove('hidden');
                    initMap();
                }
            });
        }

        // --- DRIVER LOGIC ---
        function updatePriorityList() {
            database.ref('available_drivers').on('value', snap => {
                const drivers = snap.val();
                const listUI = document.getElementById('driver-priority-list');
                listUI.innerHTML = "";
                if (!drivers) return;

                const sorted = Object.values(drivers).sort((a, b) => a.lastActive - b.lastActive);
                sorted.forEach((d, i) => {
                    const li = document.createElement('li');
                    const isMe = (d.taxiNumber === userTaxiNum) ? " â­" : "";
                    li.innerHTML = `<b>${i + 1}.</b> Î¤Î±Î¾Î¯ ${d.taxiNumber}${isMe}`;
                    listUI.appendChild(li);
                });
            });
        }

        function goOnline() {
            notificationAudio.play().then(() => { notificationAudio.pause(); notificationAudio.currentTime = 0; });
            if (navigator.geolocation) {
                const driverRef = database.ref('available_drivers/' + auth.currentUser.uid);
                driverRef.onDisconnect().remove();
                heartbeatInterval = setInterval(() => driverRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP }), 20000);
                
                document.getElementById('priority-list-container').classList.remove('hidden');
                
                watchId = navigator.geolocation.watchPosition(pos => {
                    driverRef.update({
                        taxiNumber: userTaxiNum,
                        location: { lat: pos.coords.latitude, lon: pos.coords.longitude },
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                });
                const t = translations[currentLang];
                document.getElementById('online-controls').innerHTML = `<h2 style="color:var(--danger);">${t.live}</h2><button class="btn" style="background:var(--warning); color:white;" onclick="location.reload()">${t.goOffline}</button>`;
            }
        }

        function listenForRides() {
            database.ref('ride_requests').on('value', snap => {
                const reqs = snap.val();
                if (!reqs) return;
                for (let id in reqs) {
                    if (reqs[id].targetDriverId === auth.currentUser.uid && reqs[id].status === "waiting") {
                        if (!document.getElementById('incoming-call')) {
                            notificationAudio.play();
                            showDriverAlert(id, reqs[id]);
                        }
                    }
                }
            });
        }

        function showDriverAlert(id, data) {
            const t = translations[currentLang];
            const box = document.getElementById('driver-status-box');
            const div = document.createElement('div');
            div.id = "incoming-call"; div.className = "call-alert";
            div.innerHTML = `<h3>${t.incoming}</h3><p>ğŸ‘¥: ${data.details.count} | ğŸ§³: ${data.details.hasLuggage}</p><button class="btn" style="background:var(--success); color:white;" onclick="acceptRide('${id}', '${data.passengerPhone}')">${t.accept}</button>`;
            box.appendChild(div);
        }

        function acceptRide(id, phone) {
            notificationAudio.pause();
            database.ref('ride_requests/' + id).once('value').then(snap => {
                const r = snap.val();
                database.ref('ride_requests/' + id).update({ status: "accepted" }).then(() => {
                    document.getElementById('priority-list-container').classList.add('hidden');
                    document.getElementById('driver-map-container').classList.remove('hidden');
                    
                    // Init Driver Map with Passenger Location
                    if (!driverMap) {
                        driverMap = L.map('driver-map').setView([r.passengerLocation.lat, r.passengerLocation.lon], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(driverMap);
                    }
                    L.marker([r.passengerLocation.lat, r.passengerLocation.lon]).addTo(driverMap).bindPopup("Î•Î Î™Î’Î‘Î¤Î—Î£").openPopup();

                    document.getElementById('online-controls').innerHTML = `
                        <div id="trip-panel" style="background:var(--secondary); color:white; padding:15px; border-radius:10px;">
                            <button class="btn" style="background:var(--primary); color:black;" onclick="window.location.href='tel:${phone}'">ğŸ“ ÎšÎ›Î—Î£Î— Î•Î Î™Î’Î‘Î¤Î—</button>
                            <button class="btn" style="background:var(--success); color:white;" onclick="driverArrived('${id}')">ğŸ“¢ Î•Î¦Î¤Î‘Î£Î‘</button>
                        </div>`;
                });
            });
        }

        function driverArrived(id) {
            database.ref('ride_requests/' + id).update({ status: "arrived" }).then(() => {
                document.getElementById('trip-panel').innerHTML = `<button class="btn" style="background:var(--danger); color:white;" onclick="location.reload()">ğŸ Î¤Î•Î›ÎŸÎ£ Î”Î™Î‘Î”Î¡ÎŸÎœÎ—Î£</button>`;
            });
        }

        // --- PASSENGER LOGIC ---
        function initMap() {
            navigator.geolocation.getCurrentPosition(pos => {
                map = L.map('map').setView([pos.coords.latitude, pos.coords.longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([pos.coords.latitude, pos.coords.longitude], {title: "Î•ÏƒÎµÎ¯Ï‚"}).addTo(map);
                loadTaxis();
            });
        }

        function loadTaxis() {
            database.ref('available_drivers').on('value', snap => {
                const drivers = snap.val();
                for (let id in taxiMarkers) { map.removeLayer(taxiMarkers[id]); delete taxiMarkers[id]; }
                if (!drivers) return;
                for (let id in drivers) {
                    const d = drivers[id];
                    taxiMarkers[id] = L.marker([d.location.lat, d.location.lon], { icon: taxiIcon }).addTo(map)
                        .bindPopup(`<b>Taxi No: ${d.taxiNumber}</b><br><button onclick="openRideModal('${id}')" style="background:var(--primary); border:none; padding:8px; cursor:pointer; font-weight:bold; width:100%; border-radius:5px;">ğŸš• ÎšÎ›Î—Î£Î—</button>`);
                }
            });
        }

        function openRideModal(id) { selectedDriverId = id; document.getElementById('ride-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('ride-modal').style.display = 'none'; }

        function confirmRideRequest() {
            navigator.geolocation.getCurrentPosition(pos => {
                const loc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                const count = document.getElementById('pass-count').value;
                const luggage = document.getElementById('has-luggage').checked ? "ÎÎ±Î¹" : "ÎŒÏ‡Î¹";
                const rideId = auth.currentUser.uid;

                database.ref('ride_requests/' + rideId).set({
                    passengerId: rideId, passengerPhone: userPhone, targetDriverId: selectedDriverId,
                    passengerLocation: loc, details: { count: count, hasLuggage: luggage },
                    status: "waiting", timestamp: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    closeModal();
                    database.ref('ride_requests/' + rideId).on('value', snap => {
                        const s = snap.val(); if (!s) return;
                        const view = document.getElementById('status-view');
                        document.getElementById('search-view').classList.add('hidden');
                        view.classList.remove('hidden');
                        
                        if (s.status === "accepted") {
                            view.innerHTML = `<div style="padding:30px; border:2px solid orange; border-radius:15px;"><h1>â³ ÎŸ ÎŸÎ”Î—Î“ÎŸÎ£ Î•Î¡Î§Î•Î¤Î‘Î™</h1><div class="loader"></div></div>`;
                        } else if (s.status === "arrived") {
                            view.innerHTML = `<div style="padding:30px; border:2px solid green; border-radius:15px;"><h1>ğŸš• Î¤ÎŸ Î¤Î‘ÎÎ™ Î•Î¦Î¤Î‘Î£Î•!</h1><button class="btn" onclick="location.reload()">ÎÎ•Î‘ Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î—</button></div>`;
                        } else {
                            view.innerHTML = `<div class="loader"></div><p>Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î±Ï€Î¿Î´Î¿Ï‡Î®...</p>`;
                        }
                    });
                });
            });
        }

        function logout() {
            if (userRole === 'driver') database.ref('available_drivers/' + auth.currentUser.uid).remove().then(() => auth.signOut());
            else auth.signOut();
        }
    </script>
</body>
</html>

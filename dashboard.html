<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; text-align: center; }
        .top-bar { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #loading-screen { padding-top: 100px; }
        .dashboard-container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #map { height: 450px; width: 100%; margin-top: 15px; border-radius: 8px; border: 2px solid #ffcc00; background: #e0e0e0; }
        .btn { padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; transition: 0.3s; text-decoration: none; display: inline-block; }
        .btn-call-center { background: #007bff; color: white; font-size: 1.1em; }
        .btn-call-center:hover { background: #0056b3; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <strong>ğŸš• Taxi-Line Dashboard</strong>
        <button onclick="logout()" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:5px;">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
    </div>

    <div id="loading-screen">
        <h2>ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</h2>
        <p>Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ...</p>
    </div>

    <div id="main-content" class="hidden">
        <div class="dashboard-container">
            <h2 id="welcome-msg">ÎšÎ±Î»ÏÏ‚ Î¿ÏÎ¯ÏƒÎ±Ï„Îµ</h2>
            
            <div id="driver-section" class="hidden">
                <div id="driver-status-box" style="background:#e8f5e9; padding:20px; border-radius:10px; border: 1px solid #cce5ff;">
                    <h3>ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï</h3>
                    <p>Î•Î¯ÏƒÏ„Îµ Î­Ï„Î¿Î¹Î¼Î¿Î¹ Î³Î¹Î± ÎµÏÎ³Î±ÏƒÎ¯Î±;</p>
                    <button class="btn" style="background:green; color:white; font-size:1.2em;" onclick="goOnline()">GO ONLINE</button>
                </div>
            </div>

            <div id="passenger-section" class="hidden">
                <h3>ğŸ“ Î¤Î±Î¾Î¯ ÏƒÏ„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÎ±Ï‚</h3>
                <p style="font-size: 0.9em; color: #666;">Î Î±Ï„Î®ÏƒÏ„Îµ Î­Î½Î± Ï„Î±Î¾Î¯ ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· Î³Î¹Î± Î½Î± Ï„Î¿ ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ</p>
                <div id="map"></div>
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                
                <p>Î‰ ÎºÎ±Î»Î­ÏƒÏ„Îµ Î¼Î±Ï‚ Ï„Î·Î»ÎµÏ†Ï‰Î½Î¹ÎºÎ¬:</p>
                <a href="tel:6999222446" class="btn btn-call-center">ğŸ“ ÎšÎ›Î—Î£Î— Î¡Î‘Î”Î™ÎŸÎ¤Î‘ÎÎ™</a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let map, userMarker, watchId = null;
        let taxiMarkers = {}; 
        let userLat, userLon;
        let isDriverOnline = false;

        const taxiIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUser(user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        function checkUser(uid) {
            database.ref('users/' + uid).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (!data) { window.location.href = "signup.html"; return; }

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = "ÎšÎ±Î»ÏÏ‚ Î¿ÏÎ¯ÏƒÎ±Ï„Îµ, " + data.email;

                if (data.role === 'driver') {
                    document.getElementById('driver-section').classList.remove('hidden');
                   function listenForRides() {
    const myId = auth.currentUser.uid; // Î¤Î¿ ID Ï„Î¿Ï… Î¿Î´Î·Î³Î¿Ï Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚
    
    database.ref('ride_requests').on('child_added', (snapshot) => {
        const request = snapshot.val();
        console.log("ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î± ÏƒÏ„Î· Î²Î¬ÏƒÎ·:", request); // Î“Î¹Î± Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ·

        // Î•Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½:
        // 1. ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ ÎµÎ¯Î½Î±Î¹ Online
        // 2. Î¤Î¿ status ÎµÎ¯Î½Î±Î¹ "waiting"
        // 3. Î— ÎºÎ»Î®ÏƒÎ· Î±Ï†Î¿ÏÎ¬ Î•ÎœÎ•ÎÎ‘ (targetDriverId)
        if (isDriverOnline && request.status === "waiting" && request.targetDriverId === myId) {
            const confirmRide = confirm("ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!\nÎ ÎµÎ»Î¬Ï„Î·Ï‚: " + request.passengerEmail + "\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± Ï„Î·Î½ Î±Ï€Î¿Î´ÎµÏ‡Ï„ÎµÎ¯Ï„Îµ;");
            if (confirmRide) {
                acceptRide(snapshot.key);
            }
        }
    });
}
        function loadAvailableTaxis() {
            database.ref('available_drivers').on('value', (snapshot) => {
                const drivers = snapshot.val();
                for (let id in taxiMarkers) {
                    if (!drivers || !drivers[id]) {
                        map.removeLayer(taxiMarkers[id]);
                        delete taxiMarkers[id];
                    }
                }
                if (!drivers) return;
                for (let id in drivers) {
                    const driver = drivers[id];
                    const popupContent = `
                        <div style="text-align:center;">
                            <strong>Î¤Î±Î¾Î¯ No: ${driver.taxiNumber}</strong><br>
                            <button onclick="requestSpecificRide('${id}', '${driver.taxiNumber}')" 
                                    style="background:#ffcc00; border:none; padding:8px; margin-top:8px; cursor:pointer; border-radius:5px; font-weight:bold;">
                                ğŸš• ÎšÎ›Î—Î£Î— Î¤Î‘ÎÎ™
                            </button>
                        </div>
                    `;
                    if (taxiMarkers[id]) {
                        taxiMarkers[id].setLatLng([driver.location.lat, driver.location.lon]);
                    } else {
                        taxiMarkers[id] = L.marker([driver.location.lat, driver.location.lon], { icon: taxiIcon })
                            .addTo(map).bindPopup(popupContent);
                    }
                }
            });
        }

        function requestSpecificRide(driverId, taxiNum) {
            if (!userLat || !userLon) return alert("Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Ï„Î¿Î½ ÎµÎ½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚!");
            const rideId = auth.currentUser.uid;
            database.ref('ride_requests/' + rideId).set({
                passengerId: rideId,
                passengerEmail: auth.currentUser.email,
                targetDriverId: driverId,
                taxiNumber: taxiNum,
                location: { lat: userLat, lon: userLon },
                status: "waiting",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert("ÎšÎ±Î»ÎµÎ¯Ï„Îµ Ï„Î¿ Ï„Î±Î¾Î¯ No " + taxiNum + "... Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î±Ï€Î¿Î´Î¿Ï‡Î®.");
            });
        }

        function listenForRides() {
            database.ref('ride_requests').on('child_added', (snapshot) => {
                const request = snapshot.val();
                if (isDriverOnline && request.status === "waiting") {
                    const confirmRide = confirm("ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!\nÎ ÎµÎ»Î¬Ï„Î·Ï‚: " + request.passengerEmail + "\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± Ï„Î·Î½ Î±Ï€Î¿Î´ÎµÏ‡Ï„ÎµÎ¯Ï„Îµ;");
                    if (confirmRide) {
                        acceptRide(snapshot.key);
                    }
                }
            });
        }

        function acceptRide(rideId) {
            database.ref('ride_requests/' + rideId).update({
                status: "accepted",
                driverId: auth.currentUser.uid,
                taxiNumber: "28"
            }).then(() => {
                alert("Î‘Ï€Î¿Î´ÎµÏ‡Ï„Î®ÎºÎ±Ï„Îµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ·! ÎšÎ±Ï„ÎµÏ…Î¸Ï…Î½Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î·.");
            });
        }

        function goOnline() {
            const taxiNum = "28"; 
            if (navigator.geolocation) {
                isDriverOnline = true;
                watchId = navigator.geolocation.watchPosition((pos) => {
                    userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                    const driverRef = database.ref('available_drivers/' + taxiNum);
                    driverRef.onDisconnect().remove();
                    driverRef.set({
                        taxiNumber: taxiNum,
                        status: "available",
                        lastActive: firebase.database.ServerValue.TIMESTAMP,
                        location: { lat: userLat, lon: userLon }
                    });
                }, null, { enableHighAccuracy: true });

                document.getElementById('driver-status-box').innerHTML = `
                    <div style="background:#d4edda; border:2px solid #28a745; padding:20px; border-radius:10px;">
                        <h2 style="color:#155724;">ğŸ”´ Î•Î™Î£Î¤Î• LIVE</h2>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="goOffline()">GO OFFLINE</button>
                    </div>
                `;
            }
        }

        function goOffline() {
            isDriverOnline = false;
            if (watchId) navigator.geolocation.clearWatch(watchId);
            database.ref('available_drivers/28').remove();
            location.reload();
        }

        function logout() { auth.signOut().then(() => window.location.href = "index.html"); }
    </script>
</body>
</html>

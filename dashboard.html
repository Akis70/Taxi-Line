<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f4f4; text-align: center; }
        .top-bar { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #loading-screen { padding-top: 100px; }
        .dashboard-container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #map { height: 450px; width: 100%; margin-top: 15px; border-radius: 8px; border: 2px solid #ffcc00; background: #e0e0e0; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; transition: 0.3s; text-decoration: none; display: inline-block; font-size: 16px; }
        .btn-call-center { background: #007bff; color: white; }
        .hidden { display: none; }
        .call-alert { background: #fff3e0; border: 4px solid #ff9800; padding: 15px; margin-top: 15px; border-radius: 10px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { border-color: #ff9800; } 50% { border-color: #fff; } 100% { border-color: #ff9800; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <strong>ğŸš• Taxi-Line Dashboard</strong>
        <button onclick="logout()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; cursor:pointer; border-radius:5px; font-weight:bold;">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
    </div>

    <div id="loading-screen">
        <h2>ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</h2>
    </div>

    <div id="main-content" class="hidden">
        <div class="dashboard-container">
            <h2 id="welcome-msg" style="color: #333;">ÎšÎ±Î»ÏÏ‚ Î¿ÏÎ¯ÏƒÎ±Ï„Îµ</h2>
            
            <div id="driver-section" class="hidden">
                <div id="driver-status-box" style="background:#e8f5e9; padding:20px; border-radius:10px; border: 1px solid #c8e6c9;">
                    <h3 style="margin-top:0;">ğŸ‘¨â€âœˆï¸ ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎŸÎ´Î·Î³Î¿Ï</h3>
                    <div id="online-controls">
                        <button class="btn" style="background:#2ecc71; color:white; font-size:1.2em;" onclick="goOnline()">GO ONLINE</button>
                    </div>
                </div>
            </div>

            <div id="passenger-section" class="hidden">
                <h3 style="color: #555;">ğŸ“ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¤Î±Î¾Î¯ ÎºÎ¿Î½Ï„Î¬ ÏƒÎ±Ï‚</h3>
                <div id="map"></div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                <a href="tel:6999222446" class="btn btn-call-center">ğŸ“ ÎšÎ›Î—Î£Î— Î¡Î‘Î”Î™ÎŸÎ¤Î‘ÎÎ™</a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let map, userMarker, watchId = null, heartbeatInterval = null;
        let taxiMarkers = {}; 
        let userLat, userLon, userPhone, userTaxiNum, userRole;

        const taxiIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        // --- AUTH CHECK ---
        auth.onAuthStateChanged((user) => {
            if (user) { checkUser(user.uid); } 
            else { window.location.href = "index.html"; }
        });

        function checkUser(uid) {
            database.ref('users/' + uid).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (!data) { window.location.href = "signup.html"; return; }
                
                userRole = data.role;
                userPhone = data.phone || "N/A";
                userTaxiNum = data.taxiNumber || "N/A";
                
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = "Î“ÎµÎ¹Î± ÏƒÎ±Ï‚, " + data.email;

                if (userRole === 'driver') {
                    document.getElementById('driver-section').classList.remove('hidden');
                    listenForRides();
                } else {
                    document.getElementById('passenger-section').classList.remove('hidden');
                    initMap(); 
                }
            });
        }

        // --- Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î•Î£ ÎŸÎ”Î—Î“ÎŸÎ¥ ---
        function playNotificationSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch(e) { console.log("Sound blocked by browser"); }
        }

        function listenForRides() {
            const myId = auth.currentUser.uid;
            database.ref('ride_requests').on('value', (snapshot) => {
                const requests = snapshot.val();
                if (!requests) return;

                for (let id in requests) {
                    const req = requests[id];
                    if (req.targetDriverId === myId && req.status === "waiting") {
                        showCallNotification(id, req.passengerPhone, req.details);
                    }
                }
            });
        }

        function showCallNotification(requestId, phone, details) {
            const box = document.getElementById('driver-status-box');
            if (document.getElementById('incoming-call')) return;

            playNotificationSound();
            const callDiv = document.createElement('div');
            callDiv.id = "incoming-call";
            callDiv.className = "call-alert";
            callDiv.innerHTML = `
                <h3 style="color:#e65100; margin-top:0;">ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h3>
                <p>ğŸ‘¥ Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚: <strong>${details.count}</strong> | ğŸ§³ Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚: <strong>${details.hasLuggage}</strong></p>
                <button class="btn" style="background:#2ecc71; color:white;" onclick="acceptRide('${requestId}', '${phone}')">Î‘Î ÎŸÎ”ÎŸÎ§Î— & Î•ÎšÎšÎ™ÎÎ—Î£Î—</button>
                <button class="btn" style="background:#95a5a6; color:white;" onclick="this.parentElement.remove()">Î‘Î“ÎÎŸÎ—Î£Î—</button>
            `;
            box.appendChild(callDiv);
        }

        function acceptRide(requestId, phone) {
            database.ref('ride_requests/' + requestId).update({ status: "accepted" });
            
            // Î“Î¯Î½ÎµÏ„Î±Î¹ Offline Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î³Î¹Î± Î½Î± Î¼Î·Î½ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·
            stopLocationSharing();
            database.ref('available_drivers/' + auth.currentUser.uid).remove();

            document.getElementById('online-controls').innerHTML = `
                <div style="background:#2c3e50; color:white; padding:15px; border-radius:10px;">
                    <h3>ğŸš• Î”Î™Î‘Î”Î¡ÎŸÎœÎ— Î£Î• Î•ÎÎ•Î›Î™ÎÎ—</h3>
                    <button class="btn" style="background:#f1c40f; color:#000;" onclick="window.location.href='tel:${phone}'">ğŸ“ ÎšÎ›Î—Î£Î— Î•Î Î™Î’Î‘Î¤Î—</button>
                    <button class="btn" style="background:#e74c3c; color:white;" onclick="location.reload()">ğŸ Î¤Î•Î›ÎŸÎ£ Î”Î™Î‘Î”Î¡ÎŸÎœÎ—Î£</button>
                </div>
            `;
        }

        function goOnline() {
            if (navigator.geolocation) {
                const driverRef = database.ref('available_drivers/' + auth.currentUser.uid);
                driverRef.onDisconnect().remove();

                heartbeatInterval = setInterval(() => {
                    driverRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
                }, 30000);

                watchId = navigator.geolocation.watchPosition((pos) => {
                    driverRef.update({
                        taxiNumber: userTaxiNum,
                        location: { lat: pos.coords.latitude, lon: pos.coords.longitude },
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                });

                document.getElementById('online-controls').innerHTML = `
                    <h2 style="color:#e74c3c;">ğŸ”´ Î•Î™Î£Î¤Î• LIVE</h2>
                    <p>ÎŸÎ¹ ÎµÏ€Î¹Î²Î¬Ï„ÎµÏ‚ ÏƒÎ±Ï‚ Î²Î»Î­Ï€Î¿Ï…Î½ ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·.</p>
                    <button class="btn" style="background:#f39c12; color:white;" onclick="goOffline()">GO OFFLINE</button>
                `;
            }
        }

        function stopLocationSharing() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
        }

        function goOffline() {
            stopLocationSharing();
            database.ref('available_drivers/' + auth.currentUser.uid).remove().then(() => {
                location.reload();
            });
        }

        // --- Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î•Î£ Î•Î Î™Î’Î‘Î¤Î— ---
        function initMap() {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                map = L.map('map').setView([userLat, userLon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                userMarker = L.marker([userLat, userLon]).addTo(map).bindPopup('Î— Î¸Î­ÏƒÎ· ÏƒÎ±Ï‚').openPopup();
                loadAvailableTaxis();
            }, () => alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿ GPS!"));
        }

        function loadAvailableTaxis() {
            database.ref('available_drivers').on('value', (snapshot) => {
                const drivers = snapshot.val();
                for (let id in taxiMarkers) {
                    if (!drivers || !drivers[id]) {
                        map.removeLayer(taxiMarkers[id]);
                        delete taxiMarkers[id];
                    }
                }
                if (!drivers) return;
                for (let id in drivers) {
                    const driver = drivers[id];
                    const popupContent = `
                        <div style="text-align:center;">
                            <strong>Î¤Î±Î¾Î¯ No: ${driver.taxiNumber}</strong><br>
                            <button onclick="requestSpecificRide('${id}', '${driver.taxiNumber}')" 
                                    style="background:#f1c40f; border:none; padding:8px 12px; cursor:pointer; font-weight:bold; border-radius:5px; margin-top:8px;">
                                ğŸš• ÎšÎ›Î—Î£Î— Î¤Î‘ÎÎ™
                            </button>
                        </div>`;
                    if (taxiMarkers[id]) { 
                        taxiMarkers[id].setLatLng([driver.location.lat, driver.location.lon]); 
                    } else { 
                        taxiMarkers[id] = L.marker([driver.location.lat, driver.location.lon], { icon: taxiIcon }).addTo(map).bindPopup(popupContent); 
                    }
                }
            });
        }

        function requestSpecificRide(driverId, taxiNum) {
            const passengers = prompt("Î ÏŒÏƒÎ± Î¬Ï„Î¿Î¼Î± Î¸Î± ÎµÏ€Î¹Î²Î¹Î²Î±ÏƒÏ„Î¿ÏÎ½;", "1");
            if (passengers === null) return;
            const luggage = confirm("ÎˆÏ‡ÎµÏ„Îµ Î±Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚;") ? "ÎÎ±Î¹" : "ÎŒÏ‡Î¹";

            const rideId = auth.currentUser.uid;
            database.ref('ride_requests/' + rideId).set({
                passengerId: rideId,
                passengerEmail: auth.currentUser.email,
                passengerPhone: userPhone,
                targetDriverId: driverId,
                details: { count: passengers, hasLuggage: luggage },
                status: "waiting",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => alert("Î— ÎºÎ»Î®ÏƒÎ· ÎµÏƒÏ„Î¬Î»Î·! Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î±Ï€Î¿Î´Î¿Ï‡Î® Î±Ï€ÏŒ Ï„Î¿ Î¤Î±Î¾Î¯ " + taxiNum));
        }

        function logout() {
            const exit = () => auth.signOut().then(() => window.location.href = "index.html");
            if (userRole === 'driver') {
                database.ref('available_drivers/' + auth.currentUser.uid).remove().then(exit);
            } else { exit(); }
        }
    </script>
</body>
</html>

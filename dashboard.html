<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Final Flow</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .dashboard-container { max-width: 900px; width: 95%; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px auto; }
        .nav-tabs { display: flex; justify-content: space-around; background: #333; color: white; padding: 10px; border-radius: 10px; margin-bottom: 20px; cursor: pointer; }
        .view-section { display: none; padding: 10px; text-align: center; }
        .active-view { display: block; }
        #map { height: 400px; width: 100%; border-radius: 15px; border: 2px solid #ffcc00; margin: 15px 0; background: #eee; }
        .admin-stat-card { background: #fff; padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 5px solid #ffcc00; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 10000; width: 85%; max-width: 400px; }
        .hidden { display: none; }
        .btn { cursor: pointer; border: none; font-weight: bold; border-radius: 8px; padding: 12px; margin: 5px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .taxi-badge { background: #ffcc00; color: black; padding: 4px 8px; border-radius: 5px; font-weight: bold; border: 1px solid black; white-space: nowrap; }
        .rating span { font-size: 30px; cursor: pointer; color: #ccc; }
        .rating .selected { color: #ffcc00; }
    </style>
</head>
<body style="background: #f0f0f0;">

    <div id="passenger-details-modal" class="modal hidden">
        <h3>ğŸš• Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</h3>
        <p>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î¿ Î¿Î´Î·Î³ÏŒÏ‚:</p>
        <label>ğŸ‘¥ Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚:</label>
        <select id="pax-count" style="width:100%; padding:10px; margin:10px 0; border-radius: 5px;">
            <option value="1">1 Î†Ï„Î¿Î¼Î¿</option><option value="2">2 Î†Ï„Î¿Î¼Î±</option>
            <option value="3">3 Î†Ï„Î¿Î¼Î±</option><option value="4">4 Î†Ï„Î¿Î¼Î±</option>
        </select>
        <label>ğŸ§³ Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚:</label>
        <select id="luggage-count" style="width:100%; padding:10px; margin:10px 0; border-radius: 5px;">
            <option value="ÎšÎ±Î¼Î¯Î±">ÎšÎ±Î¼Î¯Î±</option><option value="1-2 ÎœÎ¹ÎºÏÎ­Ï‚">1-2 ÎœÎ¹ÎºÏÎ­Ï‚</option>
            <option value="2-3 ÎœÎµÎ³Î¬Î»ÎµÏ‚">2-3 ÎœÎµÎ³Î¬Î»ÎµÏ‚</option><option value="Î Î¿Î»Î»Î­Ï‚">Î Î¿Î»Î»Î­Ï‚ / Special</option>
        </select>
        <button class="btn" style="background:#ffcc00; width:100%;" onclick="confirmAndSendRequest()">Î•Î Î™Î’Î•Î’Î‘Î™Î©Î£Î— ÎšÎ›Î—Î£Î—Î£</button>
        <button class="btn" style="background:#ddd; width:100%;" onclick="closeModal()">Î‘ÎšÎ¥Î¡Î©Î£Î—</button>
    </div>

    <div id="rating-modal" class="modal hidden">
        <h3>â­ Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·</h3>
        <p>Î ÏÏ‚ Î®Ï„Î±Î½ Î· ÎµÎ¼Ï€ÎµÎ¹ÏÎ¯Î± ÏƒÎ±Ï‚;</p>
        <div class="rating" id="star-rating">
            <span onclick="setRating(1)">â˜…</span><span onclick="setRating(2)">â˜…</span>
            <span onclick="setRating(3)">â˜…</span><span onclick="setRating(4)">â˜…</span>
            <span onclick="setRating(5)">â˜…</span>
        </div>
        <button class="btn" style="background:#28a745; color:white; width:100%; margin-top:15px;" onclick="submitRating()">Î¥Î ÎŸÎ’ÎŸÎ›Î—</button>
    </div>

    <div class="dashboard-container">
        <div class="nav-tabs">
            <span onclick="switchView('passenger-section')">Î•Ï€Î¹Î²Î¬Ï„Î·Ï‚</span>
            <span onclick="switchView('driver-section')">ÎŸÎ´Î·Î³ÏŒÏ‚</span>
            <span onclick="switchView('admin-section')">Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚</span>
        </div>

        <div id="passenger-section" class="view-section active-view">
            <h2>ğŸ“ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¤Î±Î¾Î¯</h2>
            <div id="map"></div>
            <button class="btn" style="background:#333; color:white; width: 100%;" onclick="openDetailsModal('any')">ğŸ“ ÎšÎ»Î®ÏƒÎ· Î ÏÏÏ„Î¿Ï… Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï…</button>
            <p id="ride-info" style="margin-top:15px; font-weight:bold; color: #e67e22; min-height: 24px;"></p>
        </div>

        <div id="driver-section" class="view-section">
            <h2>ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï (Î¤Î±Î¾Î¯ #<span id="my-taxi-id">--</span>)</h2>
            <div id="login-driver-box">
                <button class="btn" id="online-btn" style="background:#28a745; color:white; padding:15px; width:100%;" onclick="goOnline()">GO ONLINE</button>
            </div>
            
            <div id="incoming-request" class="admin-stat-card hidden" style="border: 2px solid #ffcc00; background: #fffcf0;">
                <h3 style="color:#d35400;">ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h3>
                <p id="req-details" style="font-size: 1.1em;"></p>
                <hr>
                <label>Î§ÏÏŒÎ½Î¿Ï‚ Î†Ï†Î¹Î¾Î·Ï‚:</label>
                <select id="arrival-time" style="padding:10px; border-radius:5px; width:100%; margin:10px 0;">
                    <option value="5">5 Î»ÎµÏ€Ï„Î¬</option><option value="10">10 Î»ÎµÏ€Ï„Î¬</option>
                    <option value="15">15 Î»ÎµÏ€Ï„Î¬</option><option value="30">30 Î»ÎµÏ€Ï„Î¬</option>
                </select>
                <button class="btn" style="background:#28a745; color:white; width:100%;" onclick="confirmAccept()">Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>
            </div>

            <div id="active-ride-controls" class="hidden" style="margin-top:20px;">
                <button class="btn" id="arrival-btn" style="background:#007bff; color:white; width:100%; padding:15px;" onclick="notifyArrival()">ğŸ“ Î•Î¦Î¤Î‘Î£Î‘ Î£Î¤ÎŸ Î£Î—ÎœÎ•Î™ÎŸ</button>
                <button class="btn" id="finish-btn" style="background:#333; color:white; width:100%; margin-top:10px;" onclick="finishRide()">ğŸ ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î— Î”Î™Î‘Î”Î¡ÎŸÎœÎ—Î£</button>
            </div>

            <div id="priority-list" class="admin-stat-card" style="margin-top:20px;">
                <h4>ğŸ“‹ Î£ÎµÎ¹ÏÎ¬ Î‘Î½Î±Î¼Î¿Î½Î®Ï‚</h4>
                <div id="queue-content">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ...</div>
            </div>
        </div>

        <div id="admin-section" class="view-section">
            <h2>ğŸ“Š Live Fleet Management</h2>
            <div id="admin-priority-list" class="admin-stat-card"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const userMail = localStorage.getItem("userEmail") || "Guest";
        let map, userLat, userLon, myTaxiNumber, currentRideId, selectedTarget = "any", selectedRating = 0, mapInitialized = false;

        // --- GPS & MAP INITIALIZATION ---
        function requestLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                if(!mapInitialized) initMap();
            }, () => alert("Î¤Î¿ GPS ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿."));
        }

        function initMap() {
            const container = document.getElementById('map');
            if (!container || mapInitialized || !userLat) return;
            
            map = L.map('map').setView([userLat, userLon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([userLat, userLon]).addTo(map).bindPopup('Î•ÏƒÎµÎ¯Ï‚');
            mapInitialized = true;
            syncTaxis();
        }

        function syncTaxis() {
            database.ref('available_drivers').on('value', snap => {
                // ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î±Î»Î¹ÏÎ½ markers Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ (ÎµÎ´Ï Î³Î¹Î± Î±Ï€Î»ÏŒÏ„Î·Ï„Î± Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Ï„Î± Î½Î­Î±)
                snap.forEach(child => {
                    const d = child.val();
                    if(d.status === "available" && d.email !== userMail) {
                        L.marker([d.location.lat, d.location.lon], {
                            icon: L.divIcon({className: 'taxi-icon', html: `<div class="taxi-badge">ğŸš• ${d.taxiNumber}</div>`})
                        }).addTo(map).on('click', () => openDetailsModal(d.taxiNumber));
                    }
                });
            });
        }

        // --- PASSENGER LOGIC ---
        function openDetailsModal(target) {
            selectedTarget = target;
            document.getElementById('passenger-details-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('passenger-details-modal').classList.add('hidden'); }

        function confirmAndSendRequest() {
            const pax = document.getElementById('pax-count').value;
            const lug = document.getElementById('luggage-count').value;
            const newRide = database.ref('active_requests').push();
            currentRideId = newRide.key;
            newRide.set({
                email: userMail, lat: userLat, lon: userLon, pax: pax, luggage: lug,
                targetTaxi: selectedTarget, status: "waiting", timestamp: Date.now()
            });
            closeModal();
            document.getElementById('ride-info').innerText = "Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î±Ï€Î¿Î´Î¿Ï‡Î®...";
            listenToRide();
        }

        function listenToRide() {
            database.ref('active_requests/' + currentRideId).on('value', snap => {
                const data = snap.val();
                if(!data) return;
                if(data.status === "accepted") document.getElementById('ride-info').innerHTML = `âœ… Î¤Î¿ Î¤Î±Î¾Î¯ ${data.acceptedBy} Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÎµ ${data.eta}'!`;
                if(data.status === "arrived") document.getElementById('ride-info').innerHTML = `<b style="color:#007bff;">ğŸ“ ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ Î­Ï†Ï„Î±ÏƒÎµ ÏƒÏ„Î·Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± ÏƒÎ±Ï‚!</b>`;
                if(data.status === "finished") document.getElementById('rating-modal').classList.remove('hidden');
            });
        }

        // --- DRIVER LOGIC ---
        function goOnline() {
            let storedNum = localStorage.getItem("taxiNumber");
            if(!storedNum) {
                storedNum = prompt("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ Î±ÏÎ¹Î¸Î¼ÏŒ Ï„Î±Î¾Î¯ ÏƒÎ±Ï‚:");
                if(storedNum) localStorage.setItem("taxiNumber", storedNum);
            }
            if(!storedNum) return;
            myTaxiNumber = storedNum;
            document.getElementById('my-taxi-id').innerText = myTaxiNumber;
            
            database.ref('available_drivers/' + myTaxiNumber).set({
                taxiNumber: myTaxiNumber, email: userMail, status: "available",
                lastChange: Date.now(), location: {lat: userLat, lon: userLon}
            });
            document.getElementById('login-driver-box').classList.add('hidden');
            
            database.ref('active_requests').on('child_added', snap => {
                const req = snap.val();
                if(req.status === "waiting" && (req.targetTaxi === myTaxiNumber || req.targetTaxi === "any")) {
                    currentRideId = snap.key;
                    document.getElementById('incoming-request').classList.remove('hidden');
                    document.getElementById('req-details').innerText = `ğŸ‘¥ Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚: ${req.pax} | ğŸ§³ Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚: ${req.luggage}`;
                }
            });
        }

        function confirmAccept() {
            const eta = document.getElementById('arrival-time').value;
            database.ref('active_requests/' + currentRideId).update({ status: 'accepted', eta: eta, acceptedBy: myTaxiNumber });
            database.ref('available_drivers/' + myTaxiNumber).update({ status: 'busy' });
            document.getElementById('incoming-request').classList.add('hidden');
            document.getElementById('active-ride-controls').classList.remove('hidden');
        }

        function notifyArrival() {
            database.ref('active_requests/' + currentRideId).update({ status: 'arrived' });
            alert("Î•Î¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎ±Ï„Îµ Ï„Î¿Î½ ÎµÏ€Î¹Î²Î¬Ï„Î·!");
        }

        function finishRide() {
            if(confirm("ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·

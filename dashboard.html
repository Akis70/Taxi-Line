<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #f1c40f; --secondary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f4f4; text-align: center; }
        .top-bar { background: var(--secondary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dashboard-container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #map { height: 400px; width: 100%; border-radius: 8px; border: 2px solid var(--primary); margin-top: 15px; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; transition: 0.3s; font-size: 16px; text-transform: uppercase; }
        .hidden { display: none; }
        
        /* Modals & Alerts */
        #ride-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; }
        .call-alert { background: #fff3e0; border: 4px solid var(--warning); padding: 15px; margin-top: 15px; border-radius: 10px; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--warning); border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="top-bar">
        <strong>ğŸš• Taxi-Line</strong>
        <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">Î•ÎÎŸÎ”ÎŸÎ£</button>
    </div>

    <div id="loading-screen" style="padding-top:100px;">
        <h2>ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</h2>
    </div>

    <div id="main-content" class="hidden">
        <div class="dashboard-container">
            <h2 id="welcome-msg" style="color:var(--secondary);">ÎšÎ±Î»ÏÏ‚ Î¿ÏÎ¯ÏƒÎ±Ï„Îµ</h2>
            
            <div id="driver-section" class="hidden">
                <div id="driver-status-box" style="background:#e8f5e9; padding:20px; border-radius:10px; border: 1px solid #c8e6c9;">
                    <h3 style="margin-top:0;">ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï</h3>
                    <div id="online-controls">
                        <button class="btn" style="background:var(--success); color:white;" onclick="goOnline()">GO ONLINE</button>
                    </div>
                </div>
            </div>

            <div id="passenger-section" class="hidden">
                <div id="search-view">
                    <h3>ğŸ“ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¤Î±Î¾Î¯</h3>
                    <div id="map"></div>
                    <a href="tel:6999222446" class="btn" style="background:#3498db; color:white; display:block; margin-top:15px; text-decoration:none;">ğŸ“ ÎšÎ›Î—Î£Î— Î¡Î‘Î”Î™ÎŸÎ¤Î‘ÎÎ™</a>
                </div>
                <div id="status-view" class="hidden"></div>
            </div>
        </div>
    </div>

    <div id="ride-modal">
        <div class="modal-content">
            <h3>ğŸš• Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÎšÎ»Î®ÏƒÎ·Ï‚</h3>
            <p>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎµÏ€Î¹Î²Î±Ï„ÏÎ½:</p>
            <input type="number" id="pass-count" value="1" min="1" max="8" style="width:60px; padding:10px; font-size:18px; text-align:center;">
            <div style="margin: 20px 0;">
                <label style="font-size: 18px; cursor:pointer;"><input type="checkbox" id="has-luggage" style="width:20px; height:20px;"> ÎˆÏ‡Ï‰ Î±Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚</label>
            </div>
            <button class="btn" style="background:var(--success); color:white;" onclick="confirmRideRequest()">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— ÎšÎ›Î—Î£Î—Î£</button>
            <button class="btn" style="background:#95a5a6; color:white;" onclick="closeModal()">Î‘ÎšÎ¥Î¡Î©Î£Î—</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let map, watchId, heartbeatInterval, userRole, userPhone, userTaxiNum, selectedDriverId, bellInterval;
        let taxiMarkers = {};
        const taxiIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [40, 40] });

        auth.onAuthStateChanged(user => {
            if (user) checkUser(user.uid);
            else window.location.href = "index.html";
        });

        function checkUser(uid) {
            database.ref('users/' + uid).once('value').then(snap => {
                const data = snap.val();
                if (!data) return window.location.href = "signup.html";
                userRole = data.role;
                userPhone = data.phone || "N/A";
                userTaxiNum = data.taxiNumber || "N/A";
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = "Î“ÎµÎ¹Î± ÏƒÎ±Ï‚, " + data.email;
                if (userRole === 'driver') {
                    document.getElementById('driver-section').classList.remove('hidden');
                    listenForRides();
                } else {
                    document.getElementById('passenger-section').classList.remove('hidden');
                    initMap();
                }
            });
        }

        // --- SOUND ENGINE ---
        function playTone(freq = 440, duration = 0.3) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.start(); osc.stop(ctx.currentTime + duration);
            } catch(e) {}
        }

        // --- DRIVER LOGIC ---
        function goOnline() {
            playTone(880, 0.1); // ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î®Ï‡Î¿Ï…
            if (navigator.geolocation) {
                const driverRef = database.ref('available_drivers/' + auth.currentUser.uid);
                driverRef.onDisconnect().remove();
                heartbeatInterval = setInterval(() => driverRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP }), 30000);
                watchId = navigator.geolocation.watchPosition(pos => {
                    driverRef.update({
                        taxiNumber: userTaxiNum,
                        location: { lat: pos.coords.latitude, lon: pos.coords.longitude },
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                });
                document.getElementById('online-controls').innerHTML = `<h2 style="color:var(--danger);">ğŸ”´ Î•Î™Î£Î¤Î• LIVE</h2><button class="btn" style="background:var(--warning); color:white;" onclick="location.reload()">GO OFFLINE</button>`;
            }
        }

        function listenForRides() {
            database.ref('ride_requests').on('value', snap => {
                const reqs = snap.val();
                if (!reqs) return;
                for (let id in reqs) {
                    if (reqs[id].targetDriverId === auth.currentUser.uid && reqs[id].status === "waiting") {
                        if (!document.getElementById('incoming-call')) {
                            bellInterval = setInterval(() => playTone(660, 0.4), 1000);
                            showDriverAlert(id, reqs[id]);
                        }
                    }
                }
            });
        }

        function showDriverAlert(id, data) {
            const box = document.getElementById('driver-status-box');
            const div = document.createElement('div');
            div.id = "incoming-call";
            div.className = "call-alert";
            div.innerHTML = `<h3>ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h3><p>ğŸ‘¥ Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚: ${data.details.count} | ğŸ§³ Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚: ${data.details.hasLuggage}</p><button class="btn" style="background:var(--success); color:white;" onclick="acceptRide('${id}', '${data.passengerPhone}')">Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>`;
            box.appendChild(div);
        }

        function acceptRide(id, phone) {
            if(bellInterval) clearInterval(bellInterval);
            database.ref('ride_requests/' + id).update({ status: "accepted" }).then(() => {
                if (watchId) navigator.geolocation.clearWatch(watchId);
                database.ref('available_drivers/' + auth.currentUser.uid).remove();
                document.getElementById('online-controls').innerHTML = `
                    <div id="trip-panel" style="background:var(--secondary); color:white; padding:20px; border-radius:10px; border:2px solid var(--primary);">
                        <h3 style="color:var(--primary);">ğŸš• Î”Î™Î‘Î”Î¡ÎŸÎœÎ— Î£Î• Î•ÎÎ•Î›Î™ÎÎ—</h3>
                        <button class="btn" style="background:var(--primary); color:black;" onclick="window.location.href='tel:${phone}'">ğŸ“ ÎšÎ›Î—Î£Î— Î Î•Î›Î‘Î¤Î—</button>
                        <button class="btn" style="background:var(--success); color:white;" onclick="driverArrived('${id}')">ğŸ“¢ Î•Î¦Î¤Î‘Î£Î‘ Î£Î¤ÎŸ Î£Î—ÎœÎ•Î™ÎŸ</button>
                    </div>`;
            });
        }

        function driverArrived(id) {
            database.ref('ride_requests/' + id).update({ status: "arrived" }).then(() => {
                document.getElementById('trip-panel').innerHTML = `
                    <h3 style="color:var(--success);">âœ… ÎŸ Î Î•Î›Î‘Î¤Î—Î£ Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î˜Î—ÎšÎ•</h3>
                    <p>Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Ï„Î·Î½ ÎµÏ€Î¹Î²Î¯Î²Î±ÏƒÎ·.</p>
                    <button class="btn" style="background:var(--danger); color:white;" onclick="location.reload()">ğŸ Î¤Î•Î›ÎŸÎ£ Î”Î™Î‘Î”Î¡ÎŸÎœÎ—Î£</button>`;
            });
        }

        // --- PASSENGER LOGIC ---
        function initMap() {
            navigator.geolocation.getCurrentPosition(pos => {
                map = L.map('map').setView([pos.coords.latitude, pos.coords.longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(map);
                loadTaxis();
            });
        }

        function loadTaxis() {
            database.ref('available_drivers').on('value', snap => {
                const drivers = snap.val();
                for (let id in taxiMarkers) { map.removeLayer(taxiMarkers[id]); delete taxiMarkers[id]; }
                if (!drivers) return;
                for (let id in drivers) {
                    const d = drivers[id];
                    taxiMarkers[id] = L.marker([d.location.lat, d.location.lon], { icon: taxiIcon }).addTo(map)
                        .bindPopup(`<b>Î¤Î±Î¾Î¯ No: ${d.taxiNumber}</b><br><button onclick="openRideModal('${id}')" style="background:var(--primary); border:none; padding:8px; cursor:pointer; font-weight:bold; margin-top:5px; border-radius:5px; width:100%;">ğŸš• ÎšÎ›Î—Î£Î—</button>`);
                }
            });
        }

        function openRideModal(id) { selectedDriverId = id; document.getElementById('ride-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('ride-modal').style.display = 'none'; }

        function confirmRideRequest() {
            const count = document.getElementById('pass-count').value;
            const luggage = document.getElementById('has-luggage').checked ? "ÎÎ±Î¹" : "ÎŒÏ‡Î¹";
            const rideId = auth.currentUser.uid;
            database.ref('ride_requests/' + rideId).set({
                passengerId: rideId, passengerPhone: userPhone, targetDriverId: selectedDriverId,
                details: { count: count, hasLuggage: luggage }, status: "waiting", timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                closeModal();
                database.ref('ride_requests/' + rideId).on('value', snap => {
                    const s = snap.val(); if (!s) return;
                    const view = document.getElementById('status-view');
                    document.getElementById('search-view').classList.add('hidden');
                    view.classList.remove('hidden');
                    if (s.status === "accepted") {
                        view.innerHTML = `<div style="background:#fff3e0; border:2px solid var(--warning); padding:30px; border-radius:15px;"><h1 style="color:var(--warning);">â³ ÎŸ ÎŸÎ”Î—Î“ÎŸÎ£ Î•Î¡Î§Î•Î¤Î‘Î™</h1><p>Î¤Î¿ Î¤Î±Î¾Î¯ Î±Ï€Î¿Î´Î­Ï‡Ï„Î·ÎºÎµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ·.<br>Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ...</p><div class="loader"></div></div>`;
                    } else if (s.status === "arrived") {
                        playTone(550, 0.5);
                        view.innerHTML = `<div style="background:#d4edda; border:2px solid var(--success); padding:30px; border-radius:15px;"><h1 style="color:var(--success);">ğŸš• Î¤ÎŸ Î¤Î‘ÎÎ™ Î•Î¦Î¤Î‘Î£Î•!</h1><p style="font-weight:bold;">ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ Î­Î¾Ï‰.</p><button class="btn" style="background:var(--success); color:white;" onclick="location.reload()">ÎÎ•Î‘ Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î—</button></div>`;
                    } else {
                        view.innerHTML = `<div style="padding:30px;"><h2>ğŸ“© Î— ÎºÎ»Î®ÏƒÎ· ÎµÏƒÏ„Î¬Î»Î·!</h2><p>Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ Î¿Î´Î·Î³ÏŒ...</p><div class="loader"></div></div>`;
                    }
                });
            });
        }

        function logout() {
            if (userRole === 'driver') database.ref('available_drivers/' + auth.currentUser.uid).remove().then(() => auth.signOut());
            else auth.signOut();
        }
    </script>
</body>
</html>

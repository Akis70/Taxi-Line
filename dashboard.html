<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Live Sync</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; }
        .top-bar { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-container { max-width: 900px; width: 95%; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px auto; }
        .nav-tabs { display: flex; justify-content: space-around; background: #eee; padding: 10px; border-radius: 10px; margin-bottom: 20px; cursor: pointer; }
        .nav-tabs span { padding: 8px 15px; border-radius: 5px; font-weight: bold; color: #555; }
        .nav-tabs .active-tab { background: #ffcc00; color: black; }
        .view-section { display: none; text-align: center; }
        .active-view { display: block; }
        #map { height: 450px; width: 100%; border-radius: 15px; border: 2px solid #ffcc00; margin: 15px 0; background: #ddd; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 0 40px rgba(0,0,0,0.4); z-index: 10001; width: 85%; max-width: 350px; }
        .hidden { display: none; }
        .btn { cursor: pointer; border: none; font-weight: bold; border-radius: 8px; padding: 12px; width: 100%; margin: 5px 0; }
        .btn-main { background: #ffcc00; color: black; }
        .taxi-badge { background: #ffcc00; color: black; padding: 5px 10px; border-radius: 5px; font-weight: bold; border: 1px solid black; white-space: nowrap; font-size: 14px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <span>Taxi-Line Dashboard</span>
        <button class="btn" style="width:auto; background:#c0392b; color:white; padding:5px 10px;" onclick="location.href='index.html'">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
    </div>

    <div class="dashboard-container">
        <div class="nav-tabs">
            <span id="tab-passenger" class="active-tab" onclick="switchView('passenger-section')">Î•Ï€Î¹Î²Î¬Ï„Î·Ï‚</span>
            <span id="tab-driver" onclick="switchView('driver-section')">ÎŸÎ´Î·Î³ÏŒÏ‚</span>
        </div>

        <div id="passenger-section" class="view-section active-view">
            <h2>ğŸ“ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¤Î±Î¾Î¯ ÎºÎ¿Î½Ï„Î¬ ÏƒÎ±Ï‚</h2>
            <div id="map"></div>
            <button class="btn btn-main" onclick="openDetailsModal('any')">ğŸ“ ÎšÎ»Î®ÏƒÎ· Î ÏÏÏ„Î¿Ï… Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï…</button>
            <p id="ride-info" style="margin-top:15px; font-weight:bold; color: #e67e22;"></p>
        </div>

        <div id="driver-section" class="view-section">
            <h2>ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï</h2>
            <div id="login-driver-box">
                <button class="btn" style="background:#28a745; color:white; padding:20px;" onclick="goOnline()">GO ONLINE</button>
            </div>
            
            <div id="incoming-request" class="modal hidden">
                <h3>ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h3>
                <p id="req-details"></p>
                <select id="arrival-time" style="width:100%; padding:10px; margin-bottom:10px;">
                    <option value="5">5 Î»ÎµÏ€Ï„Î¬</option><option value="10">10 Î»ÎµÏ€Ï„Î¬</option><option value="20">20 Î»ÎµÏ€Ï„Î¬</option>
                </select>
                <button class="btn btn-main" style="background:#28a745; color:white;" onclick="confirmAccept()">Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>
            </div>

            <div id="active-controls" class="hidden">
                <div class="modal">
                    <h3>ğŸš• Î”Î¹Î±Î´ÏÎ¿Î¼Î® ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·</h3>
                    <button class="btn btn-main" style="background:#007bff; color:white;" onclick="notifyArrival()">ğŸ“ Î•Î¦Î¤Î‘Î£Î‘</button>
                    <button class="btn btn-main" style="background:#333; color:white;" onclick="finishRide()">ğŸ ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î—</button>
                </div>
            </div>
        </div>
    </div>

    <div id="passenger-details-modal" class="modal hidden">
        <h3>ğŸš• Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</h3>
        <label>Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚:</label>
        <select id="pax" style="width:100%; margin-bottom:10px;"><option>1</option><option>2</option><option>3</option><option>4</option></select>
        <label>Î’Î±Î»Î¯Ï„ÏƒÎµÏ‚:</label>
        <select id="lug" style="width:100%; margin-bottom:15px;"><option>ÎšÎ±Î¼Î¯Î±</option><option>1-2</option><option>3+</option></select>
        <button class="btn btn-main" onclick="confirmAndSendRequest()">Î•Î Î™Î’Î•Î’Î‘Î™Î©Î£Î— ÎšÎ›Î—Î£Î—Î£</button>
        <button class="btn" onclick="closeModal()">Î‘ÎšÎ¥Î¡ÎŸ</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };
       firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î³Î¹Î± Ï„Î·Î½ Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·
        const database = firebase.database();
        
        // ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î±Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ
        let map, userLat, userLon, mapInitialized = false;
        let taxiMarkers = {}; 

        // ÎŸ Î•Î›Î•Î“Î§ÎŸÎ£ Î¡ÎŸÎ›ÎŸÎ¥ ÎÎ•ÎšÎ™ÎÎ‘Î•Î™ Î•Î”Î©
        auth.onAuthStateChanged((user) => {
            if (user) {
                const userMail = user.email;
                localStorage.setItem("userEmail", userMail);

                // Î¦Î­ÏÎ½Î¿Ï…Î¼Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ· Î³Î¹Î± Î½Î± Î´Î¿ÏÎ¼Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î¿Î´Î·Î³ÏŒÏ‚ Î® ÎµÏ€Î¹Î²Î¬Ï„Î·Ï‚
                database.ref('users/' + user.uid).once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    
                    if (!userData) {
                        alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€ÏÎ¿Ï†Î¯Î». Î Î±ÏÎ±ÎºÎ±Î»Ï ÎºÎ¬Î½Ï„Îµ Î¾Î±Î½Î¬ ÎµÎ³Î³ÏÎ±Ï†Î®.");
                        window.location.href = "signup.html";
                        return;
                    }

                    // 1. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎŸÎ´Î·Î³ÏŒÏ‚
                    if (userData.role === 'driver') {
                        if (userData.approved === false) {
                            // Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ³ÎºÏÎ¹Î¸ÎµÎ¯ Î±ÎºÏŒÎ¼Î± Î±Ï€ÏŒ ÎµÏƒÎ­Î½Î±
                            document.body.innerHTML = `
                                <div style="text-align:center; padding:50px; font-family:sans-serif;">
                                    <h1 style="font-size:50px;">ğŸš–</h1>
                                    <h2>Î•ÎºÎºÏÎµÎ¼ÎµÎ¯ Î· Î­Î³ÎºÏÎ¹ÏƒÎ· Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï ÏƒÎ±Ï‚</h2>
                                    <p>ÎŸ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚ (Î†ÎºÎ·Ï‚) Î¸Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± Ï„Î¿ Î¤Î±Î¾Î¯ #${userData.taxiNumber} ÏƒÏÎ½Ï„Î¿Î¼Î±.</p>
                                    <br>
                                    <button onclick="location.href='index.html'" style="padding:10px 20px; cursor:pointer;">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</button>
                                </div>`;
                        } else {
                            // Î‘Î½ ÎµÎ¯Î½Î±Î¹ ÎµÎ³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï‚, Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ Ï€Î¬Î½ÎµÎ» Î¿Î´Î·Î³Î¿Ï
                            switchView('driver-section');
                            requestLocation(); // ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Ï„Î¿ GPS
                        }
                    } else {
                        // 2. Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î•Ï€Î¹Î²Î¬Ï„Î·Ï‚, Î±Î½Î¿Î¯Î³ÎµÎ¹ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ Î¿ Ï‡Î¬ÏÏ„Î·Ï‚
                        switchView('passenger-section');
                        requestLocation(); // ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Ï„Î¿ GPS
                    }
                });
            } else {
                // Î‘Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚, Ï€Î¯ÏƒÏ‰ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ®
                window.location.href = "index.html";
            }
        });

        // Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î¿ GPS (Ï„Î·Î½ Î²Î¬Î¶Î¿Ï…Î¼Îµ Î­Î¾Ï‰ Î³Î¹Î± Î½Î± Ï„Î·Î½ ÎºÎ±Î»Î¿ÏÎ½ Î¿Î¹ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÏÏŒÎ»Î¿Î¹)
        function requestLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                initMap();
            }, () => alert("Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ GPS Î³Î¹Î± Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚."));
        }

        window.onload = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                initMap();
            }, () => alert("Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ GPS Î³Î¹Î± Ï„Î¿Î½ Ï‡Î¬ÏÏ„Î·."));
        };

        function initMap() {
            if (mapInitialized || !userLat) return;
            map = L.map('map').setView([userLat, userLon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([userLat, userLon]).addTo(map).bindPopup('Î•ÏƒÎµÎ¯Ï‚');
            mapInitialized = true;
            syncTaxis(); // ÎÎµÎºÎ¯Î½Î± Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Ï„Ï‰Î½ Ï„Î±Î¾Î¯
        }

        // --- Î— Î–Î©ÎÎ¤Î‘ÎÎ— Î£Î¥ÎÎ”Î•Î£Î— Î¤Î©Î Î¤Î‘ÎÎ™ ---
        function syncTaxis() {
            database.ref('available_drivers').on('value', snap => {
                // 1. ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿Ï…Ï‚ Ï€Î±Î»Î¹Î¿ÏÏ‚ markers
                for (let id in taxiMarkers) {
                    map.removeLayer(taxiMarkers[id]);
                }
                taxiMarkers = {};

                // 2. Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ¼Îµ Ï„Î¿Ï…Ï‚ Î½Î­Î¿Ï…Ï‚ markers
                snap.forEach(child => {
                    const d = child.val();
                    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î±Î½ ÎµÎ¯Î½Î±Î¹ available (Î±Ï†Î±Î¹ÏÎ­ÏƒÎ±Î¼Îµ Ï„Î¿ Ï†Î¯Î»Ï„ÏÎ¿ email Î³Î¹Î± Ï„Î· Î´Î¿ÎºÎ¹Î¼Î® ÏƒÎ¿Ï…)
                    if (d.status === "available") {
                        const marker = L.marker([d.location.lat, d.location.lon], {
                            icon: L.divIcon({
                                className: 'taxi-marker',
                                html: `<div class="taxi-badge">ğŸš• ${d.taxiNumber}</div>`
                            })
                        }).addTo(map);

                        marker.on('click', () => openDetailsModal(d.taxiNumber));
                        taxiMarkers[child.key] = marker;
                    }
                });
            });
        }

        function switchView(id) {
            document.querySelectorAll('.nav-tabs span').forEach(s => s.classList.remove('active-tab'));
            const tabId = (id === 'passenger-section') ? 'tab-passenger' : 'tab-driver';
            document.getElementById(tabId).classList.add('active-tab');

            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
            document.getElementById(id).classList.add('active-view');

            if(id === 'passenger-section' && mapInitialized) {
                setTimeout(() => map.invalidateSize(), 200);
            }
        }

        function goOnline() {
            let num = localStorage.getItem("taxiNumber") || prompt("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Î‘ÏÎ¹Î¸Î¼ÏŒ Î¤Î±Î¾Î¯ (Ï€.Ï‡. 42):");
            if(num) {
                localStorage.setItem("taxiNumber", num);
                database.ref('available_drivers/' + num).set({
                    taxiNumber: num, email: userMail, status: "available",
                    location: {lat: userLat, lon: userLon}, lastChange: Date.now()
                });
                document.getElementById('login-driver-box').innerHTML = `<h3>Î•Î¯ÏƒÏ„Îµ ONLINE (#${num})</h3><p>Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± ÎºÎ»Î®ÏƒÎ·...</p>`;
                listenForRequests(num);
            }
        }

        function listenForRequests(num) {
            database.ref('active_requests').on('child_added', snap => {
                const req = snap.val();
                if(req.status === "waiting" && (req.targetTaxi === num || req.targetTaxi === "any")) {
                    window.currentRideId = snap.key;
                    document.getElementById('incoming-request').classList.remove('hidden');
                    document.getElementById('req-details').innerText = `Î†Ï„Î¿Î¼Î±: ${req.pax}, Î’Î±Î»Î¯Ï„ÏƒÎµÏ‚: ${req.lug}`;
                }
            });
        }

        function confirmAccept() {
            const eta = document.getElementById('arrival-time').value;
            database.ref('active_requests/' + window.currentRideId).update({ 
                status: 'accepted', eta: eta, acceptedBy: localStorage.getItem("taxiNumber") 
            });
            database.ref('available_drivers/' + localStorage.getItem("taxiNumber")).update({ status: 'busy' });
            document.getElementById('incoming-request').classList.add('hidden');
            document.getElementById('active-controls').classList.remove('hidden');
        }

        function notifyArrival() { database.ref('active_requests/' + window.currentRideId).update({ status: 'arrived' }); }
        
        function finishRide() {
            database.ref('active_requests/' + window.currentRideId).update({ status: 'finished' });
            database.ref('available_drivers/' + localStorage.getItem("taxiNumber")).update({ status: 'available', lastChange: Date.now() });
            location.reload();
        }

        function openDetailsModal(t) { document.getElementById('passenger-details-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('passenger-details-modal').classList.add('hidden'); }

        function confirmAndSendRequest() {
            const newRide = database.ref('active_requests').push();
            window.currentRideId = newRide.key;
            newRide.set({
                email: userMail, lat: userLat, lon: userLon, status: "waiting",
                pax: document.getElementById('pax').value, lug: document.getElementById('lug').value,
                timestamp: Date.now()
            });
            closeModal();
            document.getElementById('ride-info').innerText = "Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î±Ï€Î¿Î´Î¿Ï‡Î®...";
            
            newRide.on('value', snap => {
                const d = snap.val();
                if(d && d.status === "accepted") document.getElementById('ride-info').innerHTML = `âœ… Î¤Î¿ Î¤Î±Î¾Î¯ ${d.acceptedBy} Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÎµ ${d.eta} Î»ÎµÏ€Ï„Î¬!`;
                if(d && d.status === "arrived") document.getElementById('ride-info').innerHTML = `<b style="color:blue">ğŸ“ ÎŸ ÎŸÎ´Î·Î³ÏŒÏ‚ Î­Ï†Ï„Î±ÏƒÎµ!</b>`;
                if(d && d.status === "finished") { alert("Î— Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!"); location.reload(); }
            });
        }
    </script>
</body>
</html>

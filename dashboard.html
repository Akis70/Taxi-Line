<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Pro Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .dashboard-container { max-width: 900px; width: 95%; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px auto; }
        .nav-tabs { display: flex; justify-content: space-around; background: #333; color: white; padding: 10px; border-radius: 10px; margin-bottom: 20px; cursor: pointer; }
        .view-section { display: none; padding: 10px; text-align: center; }
        .active-view { display: block; }
        #map { height: 400px; width: 100%; border-radius: 15px; border: 2px solid #ffcc00; margin: 15px 0; }
        .priority-list-container { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-top: 10px; text-align: left; }
        .admin-stat-card { background: #fff; padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 5px solid #ffcc00; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .arrival-menu { display: none; margin-top: 10px; background: #eee; padding: 10px; border-radius: 8px; }
        .hidden { display: none; }
        .btn { cursor: pointer; border: none; font-weight: bold; border-radius: 8px; padding: 10px; }
        .taxi-badge { background: #ffcc00; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body style="background: #f0f0f0;">

    <div class="dashboard-container">
        <div class="nav-tabs">
            <span onclick="switchView('passenger-section')">Î•Ï€Î¹Î²Î¬Ï„Î·Ï‚</span>
            <span onclick="switchView('driver-section')">ÎŸÎ´Î·Î³ÏŒÏ‚</span>
            <span onclick="switchView('admin-section')">Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚</span>
        </div>

        <div id="passenger-section" class="view-section active-view">
            <h2>ğŸ“ Î•Ï€Î¹Î»Î¿Î³Î® Î¤Î±Î¾Î¯</h2>
            <div id="map"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#333; color:white; flex:1;" onclick="requestFirstAvailable()">ğŸ“ ÎšÎ»Î®ÏƒÎ· ÎšÎ­Î½Ï„ÏÎ¿Ï… (Î ÏÏÏ„Î¿ Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿)</button>
            </div>
            <p id="ride-info" style="margin-top:15px; font-weight:bold; color: #e67e22;"></p>
        </div>

        <div id="driver-section" class="view-section">
            <h2>ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï (Î¤Î±Î¾Î¯ #<span id="my-taxi-id">--</span>)</h2>
            <div style="margin-bottom:15px;">
                Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¤Î±Î¾Î¯: <input type="number" id="taxi-num-input" placeholder="Ï€.Ï‡. 42" style="width:60px;">
                <button class="btn" id="online-btn" style="background:#28a745; color:white;" onclick="goOnline()">Go Online</button>
            </div>
            
            <div id="incoming-request" class="admin-stat-card hidden">
                <h3 style="color:#d35400;">ğŸ”” ÎÎ­Î± ÎšÎ»Î®ÏƒÎ·!</h3>
                <p id="req-details"></p>
                <div id="arrival-options">
                    <label>Î§ÏÏŒÎ½Î¿Ï‚ Î†Ï†Î¹Î¾Î·Ï‚:</label>
                    <select id="arrival-time">
                        <option value="5">5 Î»ÎµÏ€Ï„Î¬</option>
                        <option value="10">10 Î»ÎµÏ€Ï„Î¬</option>
                        <option value="15">15 Î»ÎµÏ€Ï„Î¬</option>
                        <option value="20">20 Î»ÎµÏ€Ï„Î¬</option>
                        <option value="30">30 Î»ÎµÏ€Ï„Î¬</option>
                        <option value="45">45 Î»ÎµÏ€Ï„Î¬</option>
                        <option value="60">60 Î»ÎµÏ€Ï„Î¬</option>
                    </select>
                    <button class="btn" style="background:#28a745; color:white;" onclick="confirmAccept()">Î‘Ï€Î¿Î´Î¿Ï‡Î®</button>
                    <button class="btn" style="background:#c0392b; color:white;" onclick="cancelRide()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                </div>
            </div>

            <div class="priority-list-container">
                <h4>ğŸ“‹ Î›Î¯ÏƒÏ„Î± Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚</h4>
                <div id="priority-list">Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± ÏƒÏÎ½Î´ÎµÏƒÎ·...</div>
            </div>
        </div>

        <div id="admin-section" class="view-section">
            <h2>ğŸ“Š Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î£Ï„ÏŒÎ»Î¿Ï…</h2>
            <div class="admin-stat-card">
                <strong>Î£Îµ Î±Î½Î±Î¼Î¿Î½Î®:</strong> <span id="user-count">...</span> | 
                <strong>Î•Î½ÎµÏÎ³Î­Ï‚ Î”Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚:</strong> <span id="ride-count">0</span>
            </div>
            <div id="admin-priority-list" class="priority-list-container"></div>
            <button class="btn" style="background:#333; color:white; margin-top:10px;" onclick="clearDatabase()">Reset Î’Î¬ÏƒÎ·Ï‚</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const userMail = localStorage.getItem("userEmail") || "Guest";
        let map, userMarker, taxiMarkers = {}, userLat, userLon, myTaxiNumber, currentRideId;

        // --- 1. Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î•Î£ Î§Î‘Î¡Î¤Î— ---
        function initMap() {
            if (map) return;
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                map = L.map('map').setView([userLat, userLon], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                userMarker = L.marker([userLat, userLon]).addTo(map).bindPopup('Î•ÏƒÎµÎ¯Ï‚');
                syncAvailableTaxis();
            });
        }

        // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Ï‰Î½ Î¤Î±Î¾Î¯ ÏƒÏ„Î¿Î½ Î§Î¬ÏÏ„Î·
        function syncAvailableTaxis() {
            database.ref('available_drivers').on('value', snap => {
                snap.forEach(child => {
                    const d = child.val();
                    if(d.status === "available" && d.taxiNumber !== myTaxiNumber) {
                        const dist = getDistance(userLat, userLon, d.location.lat, d.location.lon);
                        if(dist <= 5) { // Î¦Î¯Î»Ï„ÏÎ¿ 5Ï‡Î»Î¼
                            if(taxiMarkers[d.taxiNumber]) map.removeLayer(taxiMarkers[d.taxiNumber]);
                            taxiMarkers[d.taxiNumber] = L.marker([d.location.lat, d.location.lon], {
                                icon: L.divIcon({className: 'taxi-icon', html: `<div class="taxi-badge">${d.taxiNumber}</div>`})
                            }).addTo(map).on('click', () => callSpecificTaxi(d.taxiNumber));
                        }
                    } else if (taxiMarkers[d.taxiNumber]) {
                        map.removeLayer(taxiMarkers[d.taxiNumber]);
                    }
                });
            });
        }

        // --- 2. Î›ÎŸÎ“Î™ÎšÎ— Î•Î Î™Î’Î‘Î¤Î— ---
        function callSpecificTaxi(num) {
            if(confirm("ÎšÎ»Î®ÏƒÎ· Î¤Î±Î¾Î¯ #" + num + ";")) {
                sendRequest(num);
            }
        }

        function requestFirstAvailable() {
            sendRequest("any");
        }

        function sendRequest(target) {
            const newRide = database.ref('active_requests').push();
            currentRideId = newRide.key;
            newRide.set({
                email: userMail, lat: userLat, lon: userLon,
                targetTaxi: target, status: "waiting", timestamp: Date.now()
            });
            document.getElementById('ride-info').innerText = "Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î±Ï€Î¿Î´Î¿Ï‡Î® Î±Ï€ÏŒ Î¤Î±Î¾Î¯ " + target + "...";
            listenForRideUpdates(currentRideId);
        }

        function listenForRideUpdates(id) {
            database.ref('active_requests/' + id).on('value', snap => {
                const data = snap.val();
                if(data && data.status === "accepted") {
                    document.getElementById('ride-info').innerHTML = `âœ… Î¤Î¿ Î¤Î±Î¾Î¯ ${data.acceptedBy} Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÎµ <span style="color:red">${data.eta} Î»ÎµÏ€Ï„Î¬</span>!`;
                }
            });
        }

        // --- 3. Î›ÎŸÎ“Î™ÎšÎ— ÎŸÎ”Î—Î“ÎŸÎ¥ ---
        function goOnline() {
            myTaxiNumber = document.getElementById('taxi-num-input').value;
            if(!myTaxiNumber) return alert("Î’Î¬Î»Ï„Îµ Î½Î¿ÏÎ¼ÎµÏÎ¿ Ï„Î±Î¾Î¯!");
            document.getElementById('my-taxi-id').innerText = myTaxiNumber;
            
            database.ref('available_drivers/' + myTaxiNumber).set({
                taxiNumber: myTaxiNumber, email: userMail, status: "available",
                lastChange: Date.now(), location: {lat: userLat, lon: userLon}
            });

            // "Î‘ÎºÎ¿ÏÎµÎ¹" Î³Î¹Î± ÎºÎ»Î®ÏƒÎµÎ¹Ï‚
            database.ref('active_requests').on('child_added', snap => {
                const req = snap.val();
                if(req.status === "waiting" && (req.targetTaxi === myTaxiNumber || req.targetTaxi === "any")) {
                    currentRideId = snap.key;
                    document.getElementById('incoming-request').classList.remove('hidden');
                    document.getElementById('req-details').innerText = "Î‘Ï€ÏŒ: " + req.email;
                }
            });
        }

        function confirmAccept() {
            const eta = document.getElementById('arrival-time').value;
            database.ref('active_requests/' + currentRideId).update({
                status: 'accepted', eta: eta, acceptedBy: myTaxiNumber
            });
            database.ref('available_drivers/' + myTaxiNumber).update({ status: 'busy' });
            document.getElementById('incoming-request').classList.add('hidden');
        }

        function cancelRide() {
            if(currentRideId) database.ref('active_requests/' + currentRideId).remove();
            document.getElementById('incoming-request').classList.add('hidden');
        }

        // --- 4. Î›Î™Î£Î¤Î‘ Î Î¡ÎŸÎ¤Î•Î¡Î‘Î™ÎŸÎ¤Î—Î¤Î‘Î£ ---
        database.ref('available_drivers').orderByChild('lastChange').on('value', snap => {
            let html = "<ul>";
            snap.forEach(child => {
                const d = child.val();
                if(d.status === "available") {
                    html += `<li><b>#${d.taxiNumber}</b> - Online: ${new Date(d.lastChange).toLocaleTimeString()}</li>`;
                }
            });
            html += "</ul>";
            document.getElementById('priority-list').innerHTML = html;
            if(document.getElementById('admin-priority-list')) document.getElementById('admin-priority-list').innerHTML = html;
        });

        // Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ®: Î‘Ï€ÏŒÏƒÏ„Î±ÏƒÎ·
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
            if(viewId === 'passenger-section') setTimeout(initMap, 200);
        }

        window.onload = () => { if(userMail === "akisss70@gmail.com") switchView('admin-section'); else initMap(); };
    </script>
</body>
</html>

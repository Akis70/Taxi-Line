<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi-Line | Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .dashboard-container { max-width: 800px; width: 95%; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px auto; }
        .nav-tabs { display: flex; justify-content: space-around; background: #333; color: white; padding: 10px; border-radius: 10px; margin-bottom: 20px; cursor: pointer; }
        .nav-tabs span { padding: 5px 10px; border-radius: 5px; transition: 0.3s; }
        .nav-tabs span:hover { background: #555; }
        .view-section { display: none; padding: 10px; text-align: center; }
        .active-view { display: block; }
        #map { height: 350px; width: 100%; border-radius: 15px; border: 2px solid #ffcc00; margin: 15px 0; background: #eee; }
        .admin-stat-card { background: #f4f4f4; padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 5px solid #ffcc00; text-align: left; }
        #chat-window { position: fixed; bottom: 20px; right: 20px; width: 300px; background: white; border: 2px solid #ffcc00; border-radius: 10px; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .hidden { display: none; }
        .btn { cursor: pointer; border: none; font-weight: bold; border-radius: 8px; }
    </style>
</head>
<body style="display: block; background: #f0f0f0;">

    <div class="dashboard-container">
        <div class="nav-tabs">
            <span onclick="switchView('passenger-section')">Î•Ï€Î¹Î²Î¬Ï„Î·Ï‚</span>
            <span onclick="switchView('driver-section')">ÎŸÎ´Î·Î³ÏŒÏ‚</span>
            <span onclick="switchView('admin-section')">Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚</span>
        </div>

        <div id="passenger-section" class="view-section active-view">
            <h2>ğŸ“ ÎšÎ»Î®ÏƒÎ· Î¤Î±Î¾Î¯</h2>
            <div id="map"></div>
            <button class="btn" id="request-btn" onclick="requestTaxi()" style="background:#ffcc00; padding:15px; width: 100%;">ğŸš• Î‘Î¯Ï„Î·Î¼Î± Î³Î¹Î± Î¤Î±Î¾Î¯</button>
            <p id="ride-info" style="margin-top:10px; font-weight:bold; color: #e67e22;"></p>
        </div>

        <div id="driver-section" class="view-section">
            <h2>ğŸ‘¨â€âœˆï¸ Î Î¬Î½ÎµÎ» ÎŸÎ´Î·Î³Î¿Ï</h2>
            <button class="btn" id="online-btn" style="background:#28a745; color:white; padding:10px;" onclick="goOnline()">Go Online</button>
            <div id="requests-list" style="margin-top:20px;">
                <p id="driver-status">Î•Î¯ÏƒÏ„Îµ Offline</p>
            </div>
        </div>

        <div id="admin-section" class="view-section">
            <h2>ğŸ“Š Administrator Dashboard</h2>
            <div class="admin-stat-card">
                <strong>Î£ÏÏƒÏ„Î·Î¼Î±:</strong> <span style="color:green;">Online</span><br>
                <strong>Î•Î³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î¿Î¹ Î§ÏÎ®ÏƒÏ„ÎµÏ‚:</strong> <span id="user-count">...</span><br>
                <strong>Î•Î½ÎµÏÎ³Î­Ï‚ ÎšÎ¿ÏÏÏƒÎµÏ‚:</strong> <span id="ride-count">0</span>
            </div>
            <button class="btn" style="background:#333; color:white; padding:10px; margin-top:10px;" onclick="clearDatabase()">Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Î’Î¬ÏƒÎ·Ï‚ (Reset)</button>
        </div>

        <div class="footer-links" style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">
            <p>Call Center: <strong>+30 6999222446</strong></p>
            <button class="btn" style="padding:5px 15px;" onclick="location.href='index.html'">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
        </div>
    </div>

    <div id="chat-window" class="hidden">
        <div style="background:#ffcc00; padding:8px; font-weight:bold; display:flex; justify-content:space-between;">
            <span>Live Chat</span>
            <button onclick="document.getElementById('chat-window').classList.add('hidden')" style="border:none; background:none; cursor:pointer;">âœ–</button>
        </div>
        <div id="chat-msgs" style="height:150px; overflow-y:auto; padding:10px; font-size:13px; text-align:left;"></div>
        <div style="padding:10px; border-top:1px solid #eee; display:flex;">
            <input type="text" id="msg-input" style="flex:1;" placeholder="ÎœÎ®Î½Ï…Î¼Î±...">
            <button onclick="sendMsg()" style="background:#ffcc00; border:none; padding:5px 10px;">â”</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCzXoeqv3VODlSH6j3HrqI36ixYYdEjjI",
            authDomain: "taxi-line-f149e.firebaseapp.com",
            databaseURL: "https://taxi-line-f149e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "taxi-line-f149e",
            storageBucket: "taxi-line-f149e.firebasestorage.app",
            messagingSenderId: "1086896421565",
            appId: "1:1086896421565:web:e498b8916fd95a04e7d5d4"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const userMail = localStorage.getItem("userEmail") || "Guest";
        let map, userMarker, driverMarker, userLat, userLon, currentRideId, userRole = "passenger";

        // 1. Î•Î½Î±Î»Î»Î±Î³Î® ÎšÎ±ÏÏ„ÎµÎ»ÏÎ½
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
            if(viewId === 'passenger-section') setTimeout(initMap, 200);
        }

        // 2. Î§Î¬ÏÏ„Î·Ï‚ & GPS
        function initMap() {
            if (map) return;
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                map = L.map('map').setView([userLat, userLon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                userMarker = L.marker([userLat, userLon]).addTo(map).bindPopup('Î•Î¯ÏƒÎ±Î¹ ÎµÎ´Ï').openPopup();
            });
        }

        // 3. Î›Î¿Î³Î¹ÎºÎ® Î•Ï€Î¹Î²Î¬Ï„Î· (Request & Live Update)
        function requestTaxi() {
            if (!userLat) { alert("Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Ï„Î¿ GPS..."); return; }
            const newRide = database.ref('active_requests').push();
            currentRideId = newRide.key;
            newRide.set({
                email: userMail, lat: userLat, lon: userLon, status: "waiting", timestamp: Date.now()
            });
            document.getElementById('ride-info').innerText = "Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¿Î´Î·Î³Î¿Ï...";
            listenForUpdates(currentRideId);
        }

        function listenForUpdates(id) {
            database.ref('active_requests/' + id).on('value', snap => {
                const data = snap.val();
                if (!data) return;

                if (data.status === "accepted") {
                    document.getElementById('ride-info').innerText = "ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ Î­ÏÏ‡ÎµÏ„Î±Î¹!";
                    document.getElementById('chat-window').classList.remove('hidden');
                    
                    // Î–Î©ÎÎ¤Î‘ÎÎ— ÎšÎ™ÎÎ—Î£Î— ÎŸÎ”Î—Î“ÎŸÎ¥ Î£Î¤ÎŸÎ Î§Î‘Î¡Î¤Î— Î¤ÎŸÎ¥ Î•Î Î™Î’Î‘Î¤Î—
                    if (data.driver_location) {
                        const dLat = data.driver_location.lat;
                        const dLon = data.driver_location.lon;
                        if (!driverMarker) {
                            driverMarker = L.marker([dLat, dLon], {
                                icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [35, 35] })
                            }).addTo(map).bindPopup('Î¤Î¿ Î¤Î±Î¾Î¯ ÏƒÎ±Ï‚');
                        } else {
                            driverMarker.setLatLng([dLat, dLon]);
                        }
                    }
                }
            });
        }

        // 4. Î›Î¿Î³Î¹ÎºÎ® ÎŸÎ´Î·Î³Î¿Ï (Accept & Location Sharing)
        function goOnline() {
            userRole = "driver";
            document.getElementById('online-btn').innerText = "Î•Î¯ÏƒÏ„Îµ Online";
            document.getElementById('driver-status').innerText = "Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Ï€ÎµÎ»Î¬Ï„ÎµÏ‚...";
            database.ref('active_requests').on('child_added', snap => {
                if (snap.val().status === "waiting") {
                    const div = document.createElement('div');
                    div.id = "req-" + snap.key;
                    div.className = "admin-stat-card";
                    div.innerHTML = `Î ÎµÎ»Î¬Ï„Î·Ï‚: ${snap.val().email} <br> <button class="btn" style="background:#ffcc00; padding:5px;" onclick="acceptRide('${snap.key}')">Î‘Ï€Î¿Î´Î¿Ï‡Î®</button>`;
                    document.getElementById('requests-list').appendChild(div);
                }
            });
        }

        function acceptRide(id) {
            currentRideId = id;
            database.ref('active_requests/' + id).update({ status: 'accepted' });
            document.getElementById('driver-status').innerText = "Î”Î¹Î±Î´ÏÎ¿Î¼Î® ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·...";
            document.getElementById('chat-window').classList.remove('hidden');
            startLocationSharing(id);
        }

        function startLocationSharing(id) {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    database.ref('active_requests/' + id + '/driver_location').set({
                        lat: pos.coords.latitude, lon: pos.coords.longitude
                    });
                }, null, { enableHighAccuracy: true });
            }
        }

        // 5. Admin & Init
        window.onload = function() {
            if (userMail === "akisss70@gmail.com") {
                switchView('admin-section');
                database.ref('active_requests').on('value', s => { document.getElementById('ride-count').innerText = s.numChildren(); });
            } else {
                initMap();
            }
        };

        function clearDatabase() {
            if(confirm("Reset ÎºÎ»Î®ÏƒÎµÏ‰Î½;")) database.ref('active_requests').remove();
        }
    </script>
</body>
</html>
